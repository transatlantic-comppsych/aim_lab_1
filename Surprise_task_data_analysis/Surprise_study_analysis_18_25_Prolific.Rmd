---
title: "Surprise study analysis"
author: "Marjan Biria"
date: "2024-08-19"
output: 
    pdf_document:
    toc: true
    toc_depth: 2
    toc_float: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(root.dir = "aim_lab_1", echo = TRUE)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(lme4)
library(parameters)
library(broom.mixed)
library(purrr)
library(conflicted)
library(stringr)
library(readxl)
```


\newpage
# Study description

This is the first surprise study using the same task version as pilot 21. We had the following groups of participants with the experiment's corresponding Gorilla link:
- Prolific aged 18-25 (n = 30): https://app.gorilla.sc/admin/experiment/180921/design
- Prolific aged 26-45 (n = 38): https://app.gorilla.sc/admin/experiment/185160/design
- School students aged 14-18 (n = 30): https://app.gorilla.sc/admin/experiment/177048/design
- Promunity participants aged 18-25 (n = 24): https://app.gorilla.sc/admin/experiment/180348/design

The sample sizes include participants that potentially need to be excluded.


```{r echo=FALSE, warning=FALSE, message=FALSE}
# v3 and v4 have exactly the same task version, but BIQ was causing a problem due to a Gorilla update and it was changed in version 4

# df_Pro_18_25 <- read.csv("")
# df_Pro_18_25 <- read.csv("")
# df_Prom_18_25 <- read.csv("")
dfpro_18_25 <- read.csv("/Users/elenabagdades/Library/CloudStorage/OneDrive-UniversityCollegeLondon/Desktop/GitHub/aim_lab_1/De_identified_data/surprise_study_prolific_18-25/SUP_PRF_18-25_task_main.csv")


# read CESD, mini_SPIN for all the studies

dfpro_18_25_spin <- read.csv("/Users/elenabagdades/Library/CloudStorage/OneDrive-UniversityCollegeLondon/Desktop/GitHub/aim_lab_1/De_identified_data/surprise_study_prolific_18-25/SUP_PRF_18-25_mini_spin.csv")


```


```{r echo=FALSE, warning=FALSE, message=FALSE}
# extract CES-D scores
# CESD_data_clean <- dfpro_18_25_selected_cesd[, c(32, 34, 36, 38, 40, 42, 44, 46,48,50,
#                                  52, 54, 56, 58, 60, 62, 64, 66, 68, 70, 71 )]
# # Identify non-ID variable columns
# non_id_cols <- setdiff(names(CESD_data_clean), "Random_ID")
# 
# # Convert non-ID variables to numeric
# CESD_data_clean[, non_id_cols] <- lapply(CESD_data_clean[, non_id_cols], as.numeric)
# 
# #change numbers to match CES-D scoring system
# excluded_columns <-  c("Random_ID", "Multiple.Choice.Grid.object.3.4...I.felt.I.was.just.as.good.as.other.people..Quantised",
#                        "Multiple.Choice.Grid.object.3.8...I.felt.hopeful.about.the.future..Quantised",
#                        "Multiple.Choice.Grid.object.3.12...I.was.happy..Quantised",
#                        "Multiple.Choice.Grid.object.3.16...I.enjoyed.life..Quantised")
#                   
# 
# CESD_data_clean<- CESD_data_clean %>%
#   mutate(across(-excluded_columns , ~ case_when(
#     . == 1 ~ 0,
#     . == 2 ~ 1,
#     . == 3 ~ 2,
#     . == 4 ~ 3,
#     TRUE ~ .
#   )))
# 
# 
# other_columns <- c("Multiple.Choice.Grid.object.3.4...I.felt.I.was.just.as.good.as.other.people..Quantised",
#                    "Multiple.Choice.Grid.object.3.8...I.felt.hopeful.about.the.future..Quantised",
#                    "Multiple.Choice.Grid.object.3.12...I.was.happy..Quantised",
#                    "Multiple.Choice.Grid.object.3.16...I.enjoyed.life..Quantised")
# CESD_data_clean<- CESD_data_clean %>%
#   mutate(across(other_columns , ~ case_when(
#     . == 1 ~ 3,
#     . == 2 ~ 2,
#     . == 3 ~ 1,
#     . == 4 ~ 0,
#     TRUE ~ .
#   )))
# 
# #scoring----
# CESD_scores <-  numeric(length(CESD_data_clean$Random_ID))
# CESD_scores <- 0
# Questions <- c(1:20)
# 
# for (i in 1:nrow(CESD_data_clean)) {
#   CESD_score <- sum(CESD_data_clean[i, Questions])
#   CESD_scores[i] <- CESD_score
# }
# 
# CESD_data_clean$CESD_score <-  CESD_scores
# 
# CESD_data_clean$Depression_Threshold<- 0
# CESD_data_clean$Depression_status <- "Not_Depressed"
# 
# #Assign "1" if they meet Depression threshold 
# for (i in 1:nrow(CESD_data_clean)) {
#   if (CESD_data_clean$CESD_score[i] >= 16) {
#     CESD_data_clean$Depression_Threshold[i] <- 1
#     CESD_data_clean$Depression_status[i] <- "Depressed"
#   }
# }
```


```{r echo=FALSE, warning=FALSE, message=FALSE}
# We have now different names for different screens:
# Prediction (how well do you think you performed?)
# prediction_2 (how well do you think you performed?)
# feedback (This is how well X thought you performed)
# First 4 trials are with the histograms and are called "Trials_Histogram" in Display column instead of "Trials"
# The trial numbers start from 1 again after the histograms so we need to concatenate them all.
# Let's rename them to "Trials" to extract them together with the rest of the trials

dfpro_18_25$Trial.Number[dfpro_18_25$Display == "Trials "] <- dfpro_18_25$Trial.Number[dfpro_18_25$Display == "Trials "] + 4

dfpro_18_25 <- dfpro_18_25 %>%
  mutate(Screen = if_else(Screen == "Prediction", "Prediction ", Screen))


dfpro_18_25 <- dfpro_18_25 %>%
  mutate(Display = if_else(Display == "Trials_Histogram", "Trials ", Display))

dfpro_18_25_spin <- dfpro_18_25_spin %>%
  rename(
   "Q1" =  "Rating.Scale.object.2.Fear.of.embarrassment.causes.me.to.avoid.doing.things.or.speaking.to.people.",
   "Q2" =  "Rating.Scale.object.2.I.avoid.activities.in.which.I.am.the.center.of.attention.",
   "Q3" = "Rating.Scale.object.2.Being.embarrassed.or.looking.stupid.are.among.my.worst.fears."
  )

dfpro_18_25_spin <- dfpro_18_25_spin %>%
  rowwise() %>%
  mutate(mini_SPIN_total = sum(c(Q1, Q2, Q3), na.rm = TRUE)) %>%
  ungroup()


# create a new dfpro_18_25_selected that only keeps the columns we need
dfpro_18_25_selected <- dfpro_18_25[, c("Trial.Number", "Display", "Screen", "Response.Type", "Response", 
                     "Reaction.Time", "Spreadsheet..Histogram", "Spreadsheet..Feedback", "Random_ID")]

dfpro_18_25_selected <- dfpro_18_25_selected %>% dplyr::filter(Response.Type != "info")

dfpro_18_25_selected <- dfpro_18_25_selected %>%
  mutate(Response = as.numeric(as.character(Response))) %>%
  dplyr::filter(!is.na(Response))

dfpro_18_25_selected$Screen <- ifelse(dfpro_18_25_selected$Trial.Number == 1 & (dfpro_18_25_selected$Display == "Mood " | dfpro_18_25_selected$Display == "Anxiety "), "BL_1",
                      ifelse(dfpro_18_25_selected$Trial.Number == 2 & (dfpro_18_25_selected$Display == "Mood " | dfpro_18_25_selected$Display == "Anxiety "), "BL_2", 
                             dfpro_18_25_selected$Screen))

dfpro_18_25_selected$m_hist <- ifelse(dfpro_18_25_selected$Spreadsheet..Histogram == "h2.png", 29,
                             ifelse(dfpro_18_25_selected$Spreadsheet..Histogram == "h3.png", 37,
                                                  ifelse(dfpro_18_25_selected$Spreadsheet..Histogram == "h6.png", 63,
                                                         ifelse(dfpro_18_25_selected$Spreadsheet..Histogram == "h7.png", 71, NA))))  


# get rid of the rows we don't need: practice runs, continue button presses etc. and only keep Trials, Anxiety and Mood that include all variables we are interested in:
dfpro_18_25_selected <- dfpro_18_25_selected %>%
  dplyr::filter(
    (Display == "Trials ") |
      (Display == "Exit") |
      (Display == "Anxiety " & !Trial.Number %in% c(1, 2)) |
      (Display == "Mood " & !Trial.Number %in% c(1, 2)) 
  )

# # setting Mood and Anxiety trial numbers to match the trials starting from 1 (since we removed the baseline ones above)
dfpro_18_25_selected$Trial.Number <- ifelse(dfpro_18_25_selected$Display == 'Mood ' | dfpro_18_25_selected$Display == 'Anxiety ', dfpro_18_25_selected$Trial.Number - 2, dfpro_18_25_selected$Trial.Number)
dfpro_18_25_selected$Display <- ifelse(dfpro_18_25_selected$Display == 'Mood ' | dfpro_18_25_selected$Display == 'Anxiety ', "Trials", dfpro_18_25_selected$Display)

# renaming the feedback column to fdbk
names(dfpro_18_25_selected)[names(dfpro_18_25_selected) == 'Spreadsheet..Feedback'] <- 'fdbk'

# Now let's create columns for PE (fdbk-hist) and Subj_PE (fdbk_Prediction)

dfpro_18_25_selected$SubjPE <- ifelse(dfpro_18_25_selected$Screen == "Prediction ", dfpro_18_25_selected$fdbk - dfpro_18_25_selected$Response, NA)
dfpro_18_25_selected$PE <- ifelse(dfpro_18_25_selected$Screen == "Prediction ", dfpro_18_25_selected$fdbk - dfpro_18_25_selected$m_hist, NA)
# to keep just one repetition of feedback and mean histogram per trial per subject 
# and replace the rest with NA so that when we want to convert to long format we won't have duplicates
dfpro_18_25_selected$fdbk <- ifelse(dfpro_18_25_selected$Screen == "Prediction ", dfpro_18_25_selected$fdbk, NA)
dfpro_18_25_selected$m_hist <- ifelse(dfpro_18_25_selected$Screen == "Prediction ", dfpro_18_25_selected$m_hist, NA)
dfpro_18_25_selected$stress_level <- ifelse(dfpro_18_25_selected$Screen == "Screen 12", dfpro_18_25_selected$Response, NA)

long_dfpro_18_25_selected <- dfpro_18_25_selected %>%
  dplyr::select(Random_ID, Trial.Number, fdbk, m_hist, PE, SubjPE, stress_level) %>%
  pivot_longer(cols = c(fdbk, m_hist, PE, SubjPE, stress_level),
               names_to = "Screen",
               values_to = "Response")

# This will keep only the rows where 'Response' is not NA
long_dfpro_18_25_selected <- long_dfpro_18_25_selected[!is.na(long_dfpro_18_25_selected$Response), ]

# Selecting relevant columns from the original dfpro_18_25_selected
dfpro_18_25_selected <- dfpro_18_25_selected %>%
  dplyr::select(-c(fdbk, m_hist, PE, SubjPE, stress_level))

# Binding the rows together
dfpro_18_25_selected <- bind_rows(dfpro_18_25_selected, long_dfpro_18_25_selected)

dfpro_18_25_selected$Response <- as.numeric(dfpro_18_25_selected$Response)

# looking at the relationship between PE and SubjPE
dfpro_18_25_selected_PE <- subset(dfpro_18_25_selected, Screen == "PE")
names(dfpro_18_25_selected_PE)[names(dfpro_18_25_selected_PE) == "Screen"] <- "Screen_PE"
names(dfpro_18_25_selected_PE)[names(dfpro_18_25_selected_PE) == "Response"] <- "Response_PE"

dfpro_18_25_selected_SubjPE <- subset(dfpro_18_25_selected, Screen == "SubjPE")
names(dfpro_18_25_selected_SubjPE)[names(dfpro_18_25_selected_SubjPE) == "Screen"] <- "Screen_SubjPE"
names(dfpro_18_25_selected_SubjPE)[names(dfpro_18_25_selected_SubjPE) == "Response"] <- "Response_SubjPE"

dfpro_18_25_selected_fdbk <- subset(dfpro_18_25_selected, Screen == "fdbk")
names(dfpro_18_25_selected_fdbk)[names(dfpro_18_25_selected_fdbk) == "Screen"] <- "Screen_fdbk"
names(dfpro_18_25_selected_fdbk)[names(dfpro_18_25_selected_fdbk) == "Response"] <- "Response_fdbk"

dfpro_18_25_selected_hist <- subset(dfpro_18_25_selected, Screen == "m_hist")
names(dfpro_18_25_selected_hist)[names(dfpro_18_25_selected_hist) == "Screen"] <- "Screen_m_hist"
names(dfpro_18_25_selected_hist)[names(dfpro_18_25_selected_hist) == "Response"] <- "Response_m_hist"

dfpro_18_25_selected_stress_level <- subset(dfpro_18_25_selected, Screen == "Screen 12")
names(dfpro_18_25_selected_stress_level)[names(dfpro_18_25_selected_stress_level) == "Screen"] <- "Screen_stress_level"
names(dfpro_18_25_selected_stress_level)[names(dfpro_18_25_selected_stress_level) == "Response"] <- "Response_stress_level"

dfpro_18_25_selected_predic <- subset(dfpro_18_25_selected, Screen == "Prediction ")
names(dfpro_18_25_selected_predic)[names(dfpro_18_25_selected_predic) == "Screen"] <- "Screen_pred"
names(dfpro_18_25_selected_predic)[names(dfpro_18_25_selected_predic) == "Response"] <- "Response_pred"


# dfpro_18_25_selected_cert <- subset(dfpro_18_25_selected, Screen == "Certainty rating ")
# names(dfpro_18_25_selected_cert)[names(dfpro_18_25_selected_cert) == "Screen"] <- "Screen_certainty"
# names(dfpro_18_25_selected_cert)[names(dfpro_18_25_selected_cert) == "Response"] <- "Response_certainty"

list_of_dfs_21 <- list(dfpro_18_25_selected_PE, dfpro_18_25_selected_fdbk, dfpro_18_25_selected_hist, dfpro_18_25_selected_predic, dfpro_18_25_selected_SubjPE)

# Using reduce with inner_join
merged_dfpro_18_25_selected <- reduce(list_of_dfs_21, inner_join, by = c("Random_ID", "Trial.Number"))

dfpro_18_25_selected_Anxious <- subset(dfpro_18_25_selected, Screen == "Anxious")
names(dfpro_18_25_selected_Anxious)[names(dfpro_18_25_selected_Anxious) == "Screen"] <- "Screen_Ax"
names(dfpro_18_25_selected_Anxious)[names(dfpro_18_25_selected_Anxious) == "Response"] <- "Response_Ax"

dfpro_18_25_selected_Happy <- subset(dfpro_18_25_selected, Screen == "Happy")
# dfpro_18_25_selected_fdbk <- subset(dfpro_18_25_selected, Screen == "Prediction")
names(dfpro_18_25_selected_Happy)[names(dfpro_18_25_selected_Happy) == "Screen"] <- "Screen_H"
names(dfpro_18_25_selected_Happy)[names(dfpro_18_25_selected_Happy) == "Response"] <- "Response_H"

final_df_18_25_Pro <- merged_dfpro_18_25_selected %>%
  inner_join(dfpro_18_25_selected_Anxious, by = c("Random_ID", "Trial.Number")) %>%
  inner_join(dfpro_18_25_selected_Happy, by = c("Random_ID", "Trial.Number"))


# subset only the columns we are interested in
final_df_18_25_Pro <- final_df_18_25_Pro[c("Trial.Number", "Random_ID", "Response_H", "Response_Ax", "Response_fdbk", "Response_SubjPE", "Response_PE", "Response_m_hist", "Response_pred")]

final_df_18_25_Pro <- final_df_18_25_Pro %>%
  left_join(dfpro_18_25_spin %>% dplyr::select(Random_ID, mini_SPIN_total), by = "Random_ID")

final_df_18_25_Pro <- final_df_18_25_Pro %>%
  left_join(dfpro_18_25_selected_stress_level %>% dplyr::select(Random_ID, Response_stress_level), by = "Random_ID")

# final_df_18_25_Pro <- final_df_18_25_Pro %>%
#   left_join(CESD_data_clean %>% dplyr::select(Random_ID, CESD_score, Depression_Threshold, Depression_status), by = "Random_ID")

final_df_18_25_Pro$Social_Anxiety <- ifelse(final_df_18_25_Pro$mini_SPIN_total >= 6, "high", "low")

# excluding people with problematic performance according to Jess's video check
final_df_18_25_Pro <- final_df_18_25_Pro[!(final_df_18_25_Pro$Random_ID %in% c("SUPPRF73571")), ]


write.csv(final_df_18_25_Pro, "surprise_study_18_25_Pro_variables.csv", row.names = FALSE)


final_df_18_25_Pro %>%
  group_by(Random_ID) %>%
  summarise(Trial.Number = n())

write.csv(final_df_18_25_Pro, "final_df_18_25_Pro_with_stresslevels.csv", row.names = FALSE)

```



\newpage 
# Relationship between prediction and mean histograms (4x only in the beginning)

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations <- final_df_18_25_Pro %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_m_hist, Response_pred, method = "spearman", use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))

# # calculate the average correlation across all individuals and print it
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between mean_hist and prediction:", average_correlation)

print(message_to_print_H)

ggplot(final_df_18_25_Pro, aes(x = Response_m_hist, y = Response_pred, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +
  # labs(color="Legend") +
  theme_minimal() +
  xlab("prediction") +
  ylab("mean_histogram") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),
        axis.text.y = element_text(size = 5.5),
        strip.text.x = element_text(face = "bold"),
        strip.text.y = element_text(face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())
  
```

\newpage 
# Relationship between Anxiety and SubjPE

```{r echo=FALSE, warning=FALSE, message=FALSE}
correlations_Ax <- final_df_18_25_Pro %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax$correlation, na.rm = TRUE)
message_to_print_Ax <- paste("average correlation between anxiety and SubjPE:", average_correlation)

print(message_to_print_Ax)

ggplot(final_df_18_25_Pro, aes(x = Response_SubjPE, y = Response_Ax, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("SubjPE: feedback - prediction") + 
  ylab("Anxiety") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations_Ax, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
ylim(c(0, 100)) +
scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
xlim(c(-100, 100)) +
scale_x_continuous(breaks = seq(-80, 80, by = 50), limits = c(-80,80))
```

\newpage 
# Relationship between Mood and SubjPE

```{r echo=FALSE, warning=FALSE, message=FALSE}

correlations_M <- final_df_18_25_Pro %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2))) 

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_M$correlation, na.rm = TRUE)
message_to_print_H <- paste("average correlation between mood and SubjPE:", average_correlation)

print(message_to_print_H)

ggplot(final_df_18_25_Pro, aes(x = Response_SubjPE, y = Response_H, color = Social_Anxiety, group= Social_Anxiety)) +
  geom_point(aes(color=Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) + 
  # labs(color="Legend") +
  theme_minimal() +
  xlab("SubjPE: feedback - prediction") + 
  ylab("Mood") +
    facet_wrap(~ Random_ID, scales = "free") +
    geom_text(data=correlations_M, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    theme(strip.text = element_text(size = 6),
        axis.text.x = element_text(size = 5.5),  
        axis.text.y = element_text(size = 5.5),  
        strip.text.x = element_text(face = "bold"),  
        strip.text.y = element_text(face = "bold"),  
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  ylim(c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, by = 25), limits = c(0, 100))+
  xlim(c(-100, 100)) + 
  scale_x_continuous(breaks = seq(-80, 80, by = 50), limits = c(-80,80))
  
```



```{r echo=FALSE, warning=FALSE, message=FALSE}
# trying to keep the BL_1 and BL_2 mood and anxiety ratings
dfpro_18_25_with_BL <- dfpro_18_25[, c("Trial.Number", "Display", "Screen", "Response.Type", "Response", 
                     "Reaction.Time", "Spreadsheet..Histogram", "Spreadsheet..Feedback", "Random_ID")]

dfpro_18_25_with_BL <- dfpro_18_25_with_BL %>%
  mutate(Response = as.numeric(as.character(Response))) %>%
  dplyr::filter(!is.na(Response))

dfpro_18_25_with_BL <- dfpro_18_25_with_BL %>% dplyr::filter(Response.Type != "info")

dfpro_18_25_with_BL$Screen <- ifelse(dfpro_18_25_with_BL$Trial.Number == 1 & (dfpro_18_25_with_BL$Display == "Mood " | dfpro_18_25_with_BL$Display == "Anxiety "), "BL_1",
                      ifelse(dfpro_18_25_with_BL$Trial.Number == 2 & (dfpro_18_25_with_BL$Display == "Mood " | dfpro_18_25_with_BL$Display == "Anxiety "), "BL_2", 
                             dfpro_18_25_with_BL$Screen))

dfpro_18_25_with_BL$m_hist <- ifelse(dfpro_18_25_with_BL$Spreadsheet..Histogram == "h1.png", 21,
                      ifelse(dfpro_18_25_with_BL$Spreadsheet..Histogram == "h2.png", 29,
                             ifelse(dfpro_18_25_with_BL$Spreadsheet..Histogram == "h3.png", 37,
                                    ifelse(dfpro_18_25_with_BL$Spreadsheet..Histogram == "h4.png", 46,
                                           ifelse(dfpro_18_25_with_BL$Spreadsheet..Histogram == "h5.png", 54,
                                                  ifelse(dfpro_18_25_with_BL$Spreadsheet..Histogram == "h6.png", 63,
                                                         ifelse(dfpro_18_25_with_BL$Spreadsheet..Histogram == "h7.png", 71,
                                                                ifelse(dfpro_18_25_with_BL$Spreadsheet..Histogram == "h8.png", 80, NA))))))))  


# get rid of the rows we don't need: practice runs, continue button presses etc. and only keep Trials, Anxiety and Mood that include all variables we are interested in:
dfpro_18_25_with_BL <- dfpro_18_25_with_BL %>%
  dplyr::filter(
    (Display == "Trials ") |
      (Display == "Anxiety ") |
      (Display == "Mood ")
  )

# # setting Mood and Anxiety trial numbers to match the trials starting from 1 (since we removed the baseline ones above)
dfpro_18_25_with_BL$Trial.Number <- ifelse(dfpro_18_25_with_BL$Display == 'Mood ' | dfpro_18_25_with_BL$Display == 'Anxiety ', dfpro_18_25_with_BL$Trial.Number - 2, dfpro_18_25_with_BL$Trial.Number)
# dfpro_18_25_with_BL$Display <- ifelse(dfpro_18_25_with_BL$Display == 'Mood ' | dfpro_18_25_with_BL$Display == 'Anxiety ', "Trials", dfpro_18_25_with_BL$Display)

final_dfpro_18_25_with_BL <- dfpro_18_25_with_BL[c("Trial.Number", "Display", "Screen", "Response", "Random_ID")]

final_dfpro_18_25_with_BL <- final_dfpro_18_25_with_BL %>%
  left_join(dfpro_18_25_spin %>% dplyr::select(Random_ID, mini_SPIN_total), by = "Random_ID")

# final_dfpro_18_25_with_BL <- final_dfpro_18_25_with_BL %>%
#   left_join(CESD_data_clean %>% dplyr::select(Random_ID, CESD_score, Depression_Threshold, Depression_status), by = "Random_ID")

final_dfpro_18_25_with_BL$Social_Anxiety <- ifelse(final_dfpro_18_25_with_BL$mini_SPIN_total >= 6, "high", "low")


```



\newpage 
# Mood over time 

```{r echo=FALSE, warning=FALSE, message=FALSE}
dfpro_18_25_selected_BL_ax <- subset(final_dfpro_18_25_with_BL, Display == "Anxiety ")
dfpro_18_25_selected_BL_H <- subset(final_dfpro_18_25_with_BL,Display == "Mood ")

ggplot(dfpro_18_25_selected_BL_H, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line(color = "blue") +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") + # Adding a vertical line at Trial.Number == 1
  theme_minimal() +
  labs(title = "Mood across time",
       x = "Trial Number",
       y = "Mood",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) + 
  theme(strip.text = element_text(size = 6)) +  
  scale_x_continuous(breaks = seq(-1, 48, by = 10), limits = c(-1, 48)) +
  scale_y_continuous(breaks = seq(0, 100, by = 21), limits = c(0, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```

\newpage 
# Anxiety over time 

```{r echo=FALSE, warning=FALSE, message=FALSE}
ggplot(dfpro_18_25_selected_BL_ax, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line(color = "blue") +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") + # Adding a vertical line at Trial.Number == 1
  theme_minimal() +
  labs(title = "Anxiety across time",
       x = "Trial Number",
       y = "Anxiety",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) + 
  theme(strip.text = element_text(size = 6)) +  
  scale_x_continuous(breaks = seq(-1, 48, by = 10), limits = c(-1, 48)) +
  scale_y_continuous(breaks = seq(0, 100, by = 21), limits = c(0, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```

\newpage 
# Prediction before performance over time 

Red line presents until what points histograms were presented (4 first trials only).

```{r echo=FALSE, warning=FALSE, message=FALSE}
ggplot(final_df_18_25_Pro, aes(x = Trial.Number, y = Response_pred)) +
  geom_line(color = "blue") +
  geom_vline(xintercept = 5, linetype = "dashed", color = "red") + 
  theme_minimal() +
  labs(title = "Prediction before performance across time",
       x = "Trial Number",
       y = "Pre performance prediction",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) + 
  theme(strip.text = element_text(size = 6)) +  
  scale_x_continuous(breaks = seq(1, 48, by = 10), limits = c(1, 48)) +
  scale_y_continuous(breaks = seq(0, 100, by = 21), limits = c(0, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```


\newpage 
# Stress levels and social anxiety

```{r echo=FALSE, warning=FALSE, message=FALSE}
onetrial_final_df_18_25_Pro <- subset(final_df_18_25_Pro, final_df_18_25_Pro$Trial.Number == 1)


ggplot(onetrial_final_df_18_25_Pro, aes(x = Social_Anxiety, y = Response_stress_level , fill = Social_Anxiety)) +
  geom_boxplot(outlier.colour = "black") +
  stat_boxplot(geom = "errorbar",
               width = 0.15) + 
  geom_point(color = "black", position = position_jitter(width = 0.1), alpha = 0.7) +
  theme_minimal() +
  # labs(x = "Display", y = "Response") +
  # scale_y_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  # ggtitle("Average anxiety ratings in pilots 1 and 2 in socially anxious people") +
  xlab("") + 
  ylab("stress levels (0-10)") +
  # facet_wrap(~pilot_nr, scales = "free") +
  # scale_fill_manual(values = c("black", "purple", "darkgreen", "blue"))+
  # ylim(c(50, 100)) + 
  scale_y_continuous(breaks = seq(0, 10, by = 1), limits = c(1, 10))+
  theme(
    panel.grid.major = element_blank(),  # Removes major grid lines
    panel.grid.minor = element_blank(),  # Removes minor grid lines
    panel.border = element_blank(),      # Removes the border line
    axis.line = element_blank(),          # Removes axis lines
    plot.background = element_rect(fill = "white", colour = NA)   # Ensure plot background is white
  )

```

\newpage
# LME models for Mood and SubjPE

The best model seems to be: Mood ~ SubjPE + mini_SPIN_total + (SubjPE | Random_ID)

```{r echo=FALSE, warning=FALSE, message=FALSE}
model1 <- lme4::lmer(Response_H ~ Response_SubjPE +  (Response_SubjPE | Random_ID), data = final_df_18_25_Pro, control=lmerControl(optimizer="bobyqa"))
model2 <- lme4::lmer(Response_H ~ Response_SubjPE +  mini_SPIN_total + (1 | Random_ID), data = final_df_18_25_Pro, control=lmerControl(optimizer="bobyqa"))
model3 <- lme4::lmer(Response_H ~ Response_SubjPE + mini_SPIN_total + (Response_SubjPE | Random_ID), data = final_df_18_25_Pro, control=lmerControl(optimizer="bobyqa"))

AIC(model1)
AIC(model2)
AIC(model3)

coef_fixed <- fixef(model3)
intercept_Response_H <- coef_fixed[1]
slope_Response_H <- coef_fixed[2]
standard_beta_Response_SubjPE <- parameters:: standardise_parameters (model3)

# Hypothetical standard errors for intercept and slope
vcov_matrix <- vcov(model3)  # Variance-covariance matrix of fixed effects
SE_intercept <- sqrt(vcov_matrix[1, 1])  # Standard error for the intercept
SE_slope <- sqrt(vcov_matrix[2, 2])      # Standard error for the slope
  # Placeholder value
CI_multiplier <- 1.96  # 95% CI multiplier for a normal distribution

# Creating a sequence of `SubjPE` values for prediction
Response_SubjPE_range <- seq(min(final_df_18_25_Pro$Response_SubjPE), max(final_df_18_25_Pro$Response_SubjPE), length.out = 100)

# Calculating predicted Response_H and its CI bounds across the SubjPE range
predicted_Response_H <- intercept_Response_H + slope_Response_H * Response_SubjPE_range
CI_lower <- predicted_Response_H - CI_multiplier * sqrt(SE_intercept^2 + (Response_SubjPE_range^2 * SE_slope^2))
CI_upper <- predicted_Response_H + CI_multiplier * sqrt(SE_intercept^2 + (Response_SubjPE_range^2 * SE_slope^2))

# Preparing a data frame for ggplot
CI_data <- data.frame(Response_SubjPE=Response_SubjPE_range, CI_lower=CI_lower, CI_upper=CI_upper)


ggplot(final_df_18_25_Pro, aes(x=Response_SubjPE, y=Response_H)) +
  # Adding points from your dataset
  # geom_point() +
  # Adding a regression line
  geom_abline(intercept=intercept_Response_H, slope=slope_Response_H, color="darkgoldenrod1", linetype="dashed", size=1) +
  # Adding the confidence interval with geom_ribbon
  geom_ribbon(data=CI_data, aes(x=Response_SubjPE, ymin=CI_lower, ymax=CI_upper), fill="gray80", alpha=0.5, inherit.aes = FALSE) +
  # Further customization
  xlab("Social PE") + 
  ylab("Mood") +
  ggtitle("", subtitle=paste("Estimated slopes of the association in n = ", length(unique(final_df_18_25_Pro$Random_ID)))) +
  theme(plot.title=element_text(size=12), plot.subtitle=element_text(size=10),
        legend.title=element_text(size=12), legend.text=element_text(size=12),
        axis.title=element_text(size=13),
        axis.text=element_text(size=12),
        panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(),
        panel.border=element_rect(colour="black", fill=NA)) +
  annotate("label", x=12, y=55, label=paste("beta =", round(standard_beta_Response_SubjPE$Std_Coefficient[2],2), ", 95%CI =", 
                                            round(standard_beta_Response_SubjPE$CI_low[2],2), "-", round(standard_beta_Response_SubjPE$CI_high[2],2))) +
  scale_y_continuous(breaks=seq(0, 100, by=20), limits=c(0, 100)) +
  scale_x_continuous(breaks=seq(-80, 80, by=40), limits=c(-80, 80))

```

\newpage
# LME models for Anxiety and SubjPE

The best model seems to be: Anxiety ~ SubjPE + mini_SPIN_total + (SubjPE | Random_ID)

```{r echo=FALSE, warning=FALSE, message=FALSE}
model1 <- lme4::lmer(Response_Ax ~ Response_SubjPE +  (Response_SubjPE | Random_ID), data = final_df_18_25_Pro, control=lmerControl(optimizer="bobyqa"))
model2 <- lme4::lmer(Response_Ax ~ Response_SubjPE +  mini_SPIN_total + (1 | Random_ID), data = final_df_18_25_Pro, control=lmerControl(optimizer="bobyqa"))
model3 <- lme4::lmer(Response_Ax ~ Response_SubjPE + mini_SPIN_total + (Response_SubjPE | Random_ID), data = final_df_18_25_Pro, control=lmerControl(optimizer="bobyqa"))

AIC(model1)
AIC(model2)
AIC(model3)

coef_fixed <- fixef(model3)
intercept_Response_Ax <- coef_fixed[1]
slope_Response_Ax <- coef_fixed[2]
standard_beta_Response_SubjPE <- parameters:: standardise_parameters (model3)

# Hypothetical standard errors for intercept and slope
vcov_matrix <- vcov(model3)  # Variance-covariance matrix of fixed effects
SE_intercept <- sqrt(vcov_matrix[1, 1])  # Standard error for the intercept
SE_slope <- sqrt(vcov_matrix[2, 2])      # Standard error for the slope
# Placeholder value
CI_multiplier <- 1.96  # 95% CI multiplier for a normal distribution

# Creating a sequence of `SubjPE` values for prediction
Response_SubjPE_range <- seq(min(final_df_18_25_Pro$Response_SubjPE), max(final_df_18_25_Pro$Response_SubjPE), length.out = 100)

# Calculating predicted Response_Ax and its CI bounds across the SubjPE range
predicted_Response_Ax <- intercept_Response_Ax + slope_Response_Ax * Response_SubjPE_range
CI_lower <- predicted_Response_Ax - CI_multiplier * sqrt(SE_intercept^2 + (Response_SubjPE_range^2 * SE_slope^2))
CI_upper <- predicted_Response_Ax + CI_multiplier * sqrt(SE_intercept^2 + (Response_SubjPE_range^2 * SE_slope^2))

# Preparing a data frame for ggplot
CI_data <- data.frame(Response_SubjPE=Response_SubjPE_range, CI_lower=CI_lower, CI_upper=CI_upper)


ggplot(final_df_18_25_Pro, aes(x=Response_SubjPE, y=Response_Ax)) +
  # Adding points from your dataset
  # geom_point() +
  # Adding a regression line
  geom_abline(intercept=intercept_Response_Ax, slope=slope_Response_Ax, color="darkgoldenrod1", linetype="dashed", size=1) +
  # Adding the confidence interval with geom_ribbon
  geom_ribbon(data=CI_data, aes(x=Response_SubjPE, ymin=CI_lower, ymax=CI_upper), fill="gray80", alpha=0.5, inherit.aes = FALSE) +
  # Further customization
  xlab("Social PE") + 
  ylab("Anxiety") +
  ggtitle("", subtitle=paste("Estimated slopes of the association in n = ", length(unique(final_df_18_25_Pro$Random_ID)))) +
  theme(plot.title=element_text(size=12), plot.subtitle=element_text(size=10),
        legend.title=element_text(size=12), legend.text=element_text(size=12),
        axis.title=element_text(size=13),
        axis.text=element_text(size=12),
        panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(),
        panel.border=element_rect(colour="black", fill=NA)) +
  annotate("label", x=12, y=55, label=paste("beta =", round(standard_beta_Response_SubjPE$Std_Coefficient[2],2), ", 95%CI =", 
                                            round(standard_beta_Response_SubjPE$CI_low[2],2), "-", round(standard_beta_Response_SubjPE$CI_high[2],2))) +
  scale_y_continuous(breaks=seq(0, 100, by=20), limits=c(0, 100)) +
  scale_x_continuous(breaks=seq(-80, 80, by=40), limits=c(-80, 80))
```


\newpage 
# ICC for Mood 
```{r echo=FALSE, warning=FALSE, message=FALSE}
test_icc_id <- lmer(Response_H ~  (1| Random_ID), data = 
                      final_df_18_25_Pro, 
                    REML = FALSE, 
                    control = lmerControl(optimizer = "bobyqa")) 
icc_results_id <- performance::icc(test_icc_id)

icc_results_id
```

\newpage 
# ICC for Anxiety
```{r echo=FALSE, warning=FALSE, message=FALSE}
test_icc_id <- lmer(Response_Ax ~  (1| Random_ID), data = 
                      final_df_18_25_Pro, 
                    REML = FALSE, 
                    control = lmerControl(optimizer = "bobyqa")) 
icc_results_id <- performance::icc(test_icc_id)

icc_results_id
```
