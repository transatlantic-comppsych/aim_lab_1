---
output:
  pdf_document: default
---

---
output:
  pdf_document:
    geometry: margin=1in
---

---
output: pdf_document
pdf_document: default
---
<br>
<br>

---
author: "Marjan biria"
output: github_document
---

<br><br>

## Surprise study 
<br>
This file contains all the analyses used for the different versions of the surprise task and pilots. <br> <br>

#### Pilot 1 (face/emotion rating) : to be added <br>
**Goal:** to find faces that seem crticial/easy-going to most people which then would be used in the main task to induce expectation. We tested whether neutral faces can be observed to be more critical compared to happy faces. We also did another analysis selecting the most crticial faces (need to ask Elena for this data as it was completed while I was on AL). 
Platform: Testable_Minds, Prolific
<br><br>

#### Pilot 2 (feedback statements using videos): to be added <br>
**Goal:** to collect statements that can be used to provide feedback that is either neutral or positive.
We collected statements from participants after they watched a video of someone doing the same task (describing a picture). Initially not successful, however, after changing the instructions to provide examples of positive and neutral statements the quality of statements we received improved. 
Platform: Testable_Minds, Prolific
<br><br>

#### Pilot 3 (feedback statements using 2 lists): to be added <br>
**Goal:** to collect statements that can be used to provide feedback that is either neutral or positive, as pilot 2 had not been very successful at first.We generated two lists of statements using CHATGPT3 and asked participants to choose which one makes them feel more confident (presenting only 2 options at a time). 
Platform: Testable_Minds, Prolific
<br><br>


#### Pilot 4: prediction + no feedback (to test whether histograms can induce expectation)
<br> 
**Goal:**This was a pilot to test whether or not histograms can induce expectation. 
The following data was collected on Prolific. The first section looks at the relationship between histogram mean with the  participant's expectation. In this version of the task participants did not receive any feedback: https://app.gorilla.sc/admin/experiment/142855/design
Platform: Prolific and MTurk

There were three different versions: <br>
**batch1)** audio + video: we started by collecting data in 6 participants including both audio and video. Since the recruitment was slow, we decided to remove the video recordings to see whether having the audio alone would speed up the data collection. 
<br>
**batch2)** audio only: we collected data from only 1 participant and thus decided that the video could not be the only problem. After testing participants on mturk and seeing the rate being even slower than Prolific, we decided to increase the screened participants on Prolific, to have a larger pool to test from. We screened 600 people out of which 357 had high social anxiety scores on MINI-SPIN (>= 6). <br>
**batch3)** audio + video: we tested 34 participants on Prolific using different histogram means and sd. So the difference between batches 1 and 3 is in the histograms we used, also for study 1 we do not have the video recordings as due to a technical mistake on Gorilla the audio files overwrote the video files which is now fixed to in batch3.

In batch3, the histogram mean and sd were changed so that we can less extreme values, so that when used in the following pilots to generate feedback, it can still be within the 10-100 limit. The histograms that were used in batches 1 and 2 have means of (10,20,30,40,60,70,80,90) and sd = 5, and the ones in batch3 had means of (20, 29, 37, 46, 54, 63, 71, 80) and sd = 3. Besides making the histograms narrower, we also did not want the mean values to be increments of 10 starting from 20, so that we could use them as feedback in one of the following pilot tasks (as non-random feedback to create zero prediction-error).


```{r setup, include=FALSE}
knitr::opts_chunk$set(root.dir = "aim_lab_1", echo = TRUE)
```


```{r echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
```

\newpage We can see below the data from batch 1 of pilot 4: prediction with no feedback on Prolific:
```{r echo=FALSE}
df1 <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_pilot_pred_nopic_vid/SUP_PRF_pilot_pred_nopic_vid_v5/SUP_PRF_pilot_pred_nopic_vid_v5_task_main.csv") # Prolific, no picture taken
df2 <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_pilot_pred_nopic_aud/SUP_PRF_pilot_pred_nopic_aud_v5/SUP_PRF_pilot_pred_nopic_aud_v5_task_main.csv") # Prolific, no picture taken, only audio (no video)
```

```{r echo=FALSE}
# Check if both dataframes have the same columns in the same order.
# This step is to ensure that the concatenation process is correct.
if (!(identical(colnames(df1), colnames(df2)))) {
  stop("The two dataframes have different columns or order of columns!")
}

# # Find columns in df1 not in df2
# missing_in_df2 <- setdiff(colnames(df1), colnames(df2))
# print(missing_in_df2)
# 
# # Find columns in df2 not in df1
# missing_in_df1 <- setdiff(colnames(df2), colnames(df1))
# print(missing_in_df1)
# 
# # until we replace the first CSV file with the random_ID version, we need to do the following to run this code:
# colnames(df1)[colnames(df1) == "Participant.Public.ID"] <- "Random_ID"
# 
# # now if we run this again it should not give an error
# if (!(identical(colnames(df1), colnames(df2)))) {
#   stop("The two dataframes have different columns or order of columns!")
# }
# 
# # they seem to have a different order too (delete these after adding the correct CSV file)
# cols_df1 <- colnames(df1)
# cols_df2 <- colnames(df2)
# 
# different_order <- which(cols_df1 != cols_df2)
# print(different_order)
# 
# if(length(different_order) > 0) {
#   print(paste("Differently ordered columns at positions:", 
#               paste(different_order, collapse = ", ")))
#   print(paste("In df1:", paste(cols_df1[different_order], collapse = ", ")))
#   print(paste("In df2:", paste(cols_df2[different_order], collapse = ", ")))
# } else {
#   print("The column order is identical.")
# }
# 
# # it seems in the new files, Random_ID is at the end of the dataframe
# cols <- colnames(df1)[colnames(df1) != "Random_ID"]
# df1 <- df1[, c(cols, "Random_ID")]
# 
# if (!(identical(colnames(df1), colnames(df2)))) {
#   stop("The two dataframes have different columns or order of columns!")
# }

# now that the two files are the same let's continue.

# let's first look at the first 7 subjects in df1 and df2, who had different historagms means and sds
# 3. Concatenate the data frames
df12 <- rbind(df1, df2)
df12_mood <- subset(df12, Response.Type == "tooEarly")
df12 <- subset(df12, Response.Type == "response")
df12 <- subset(df12, Spreadsheet..Display == "Trials ")


df12$m_hist <- ifelse(df12$Spreadsheet..Histogram == "Histogram_1.png", 10,
                       ifelse(df12$Spreadsheet..Histogram == "Histogram_2.png", 20,
                              ifelse(df12$Spreadsheet..Histogram == "Histogram_3.png", 30,
                                     ifelse(df12$Spreadsheet..Histogram == "Histogram_4.png", 40,
                                            ifelse(df12$Spreadsheet..Histogram == "Histogram_5.png", 60,
                                                   ifelse(df12$Spreadsheet..Histogram == "Histogram_6.png", 70,
                                                          ifelse(df12$Spreadsheet..Histogram == "Histogram_7.png", 80,
                                                                 ifelse(df12$Spreadsheet..Histogram == "Histogram_8.png", 90, NA))))))))  

```

<br> This figure below shows the relationship between histogram means and the predictions.<br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
df12_pred <- subset(df12, Screen == "Prediction ")
df12_conf <- subset(df12, Screen == "Certainty rating ")
df12_pred$Response <- as.numeric(as.character(df12_pred$Response))
df12_mood$Response <- as.numeric(as.character(df12_mood$Response))


ggplot(df12_pred, aes(x=Response, y=m_hist)) +
  geom_point(aes(color="Data Points")) +
    geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal()+
  xlab("Expectation") + 
  ylab("Histogram means")
```

<br> The figure below shows the histogram and expectation values over time and across trials. <br>


```{r echo=FALSE, warning=FALSE, message=FALSE}
df12_pred_trial_nr <- df12_pred %>%
  group_by(Random_ID) %>%
  mutate(trial_nr = row_number()) %>%
  ungroup()

df12_long <- df12_pred_trial_nr %>%
  pivot_longer(cols = c(Response, m_hist), names_to = "Metric", values_to = "Value") %>%
  mutate(Metric = recode(Metric, 
                         Response = "Predictions", 
                         m_hist = "Histograms"))

# Create the plot with facet_wrap
ggplot(df12_long, aes(x = trial_nr, y = Value, color = Metric, group = Metric)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Expectation across time",
       x = "Trial Number",
       y = "Expectation",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 1) # Separate plot for each ID, one column layout

```


<br> we will now make the same plots for mood (asking people how happy they are) and anxiety <br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
# Create the plot with facet_wrap
  ggplot(df12_mood, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Mood and anxiety across time",
       x = "Trial Number",
       y = "mood/happiness and anxiety",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 1) # Separate plot for each ID, one column layout

```

  
The following people had different histogram means and smaller sd for histograms, so we plot them separately despite having a similar task design and also being from Prolific.

```{r echo=FALSE}
df3 <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_pilot_pred_nopic_vid/SUP_PRF_pilot_pred_nopic_vid_v8/SUP_PRF_pilot_pred_nopic_vid_v8_task_main.csv")   # Prolific, no picture taken, has both audio and video, histograms had different means () and sd = 3 to be narrower, this change was made to help us create histograms that would allow us create prediction errors more easily.

if (!(identical(colnames(df1), colnames(df3)))) {
  stop("The two dataframes have different columns or order of columns!")
}

# let's now look at the second 34 subjects in df3 who had different historagms means and sds
df3_mood <- subset(df3, Response.Type == "tooEarly")
df3 <- subset(df3, Response.Type == "response")
df3 <- subset(df3, Spreadsheet..Display == "Trials ")

df3$m_hist <- ifelse(df3$Spreadsheet..Histogram == "Histogram_1.png", 20,
                       ifelse(df3$Spreadsheet..Histogram == "Histogram_2.png", 29,
                              ifelse(df3$Spreadsheet..Histogram == "Histogram_3.png", 37,
                                     ifelse(df3$Spreadsheet..Histogram == "Histogram_4.png", 46,
                                            ifelse(df3$Spreadsheet..Histogram == "Histogram_5.png", 54,
                                                   ifelse(df3$Spreadsheet..Histogram == "Histogram_6.png", 63,
                                                          ifelse(df3$Spreadsheet..Histogram == "Histogram_7.png", 71,
                                                                 ifelse(df3$Spreadsheet..Histogram == "Histogram_8.png", 80, NA))))))))  

```
<br> <br> 
Let's now look at 34 subjects in batch3 who had different histogram means and sd: <br> <br> <br> 

```{r echo=FALSE, warning=FALSE, message=FALSE}
df3_pred <- subset(df3, Screen == "Prediction ")
df3_conf <- subset(df3, Screen == "Certainty rating ")
df3_pred$Response <- as.numeric(as.character(df3_pred$Response))
df3_mood$Response <- as.numeric(as.character(df3_mood$Response))


p <- ggplot(df3_pred, aes(x=Response, y=m_hist)) +
  geom_point(aes(color="Data Points")) +
    geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal()+
  xlab("Expectation") + 
  ylab("Histogram means")

print(p)
```

<br><br><br>
Below we can see the histogram means and expectation values across trials:
<br><br><br>


```{r echo=FALSE, warning=FALSE, message=FALSE}
df3_pred_trial_nr <- df3_pred %>%
  group_by(Random_ID) %>%
  mutate(trial_nr = row_number()) %>%
  ungroup()

df3_long <- df3_pred_trial_nr %>%
  pivot_longer(cols = c(Response, m_hist), names_to = "Metric", values_to = "Value") %>%
  mutate(Metric = recode(Metric, 
                         Response = "Predictions", 
                         m_hist = "Histograms"))

# Create the plot with facet_wrap
p <- ggplot(df3_long, aes(x = trial_nr, y = Value, color = Metric, group = Metric)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Expectation across time",
       x = "Trial Number",
       y = "Expectation",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) # Separate plot for each ID, one column layout
print(p)
```


<br> we will now make the same plots for mood (asking people how happy they are) and anxiety <br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
# Create the plot with facet_wrap
  ggplot(df3_mood, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Mood and anxiety across time",
       x = "Trial Number",
       y = "mood/happiness and anxiety",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) # Separate plot for each ID, one column layout

```


```{r echo=FALSE, warning=FALSE, message=FALSE}
df3_pred$Response <- as.numeric(as.character(df3_pred$Response))

correlations_mean_df3 <- df3_pred %>%
  group_by(Random_ID) %>%
  summarize(correlation = cor(Response, m_hist, use = "complete.obs"),
            .groups = 'drop')  # This line is used to avoid a grouped df as output

```

<br><br><br>
Below we can see the average correlation and the histogram of the average:
<br><br><br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
m <- mean(correlations_mean_df3$correlation)
print(paste("average of correlations:", m))
s <- sd(correlations_mean_df3$correlation)
print(paste("sd of correlations:", s))

hist(correlations_mean_df3$correlation)
```

\newpage we will now look at the relationship between anxiety and mood
```{r echo=FALSE, warning=FALSE, message=FALSE}
df3_Anxious <- subset(df3_mood, Screen == "Anxious")
names(df3_Anxious)[names(df3_Anxious) == "Screen"] <- "Screen_Ax"
names(df3_Anxious)[names(df3_Anxious) == "Response"] <- "Response_Ax"

df3_Happy <- subset(df3_mood, Screen == "Happy")
# df_fdbk <- subset(df, Screen == "Prediction")
names(df3_Happy)[names(df3_Happy) == "Screen"] <- "Screen_H"
names(df3_Happy)[names(df3_Happy) == "Response"] <- "Response_H"


final_df3 <- inner_join(df3_Anxious, df3_Happy, by = c("Random_ID", "Trial.Number"))


# Calculate correlation by Random_ID for anxiety
correlations_Ax_H_df3 <- final_df3 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_H, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation_df3 <- mean(correlations_Ax_H_df3$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and Happiness:", average_correlation_df3)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(final_df3$Response_Ax, na.rm = TRUE)
y_range <- range(final_df3$Response_SubjPE, na.rm = TRUE)

ggplot(final_df3, aes(x=Response_Ax, y=Response_H)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("Happiness/Mood") +
  # Add the correlation labels
  # geom_text(data=correlations_Ax_H, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
     # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))
```


```{r echo=FALSE, warning=FALSE, message=FALSE}
library(irr)
library(lme4)
library(psych)

# final_df3[final_df3$Trial.Number==3, ]$Response_H, final_df3[final_df3$Trial.Number==50, ]$Response_H]
trials_1 <- subset(final_df3, Trial.Number == 3)
trials_48 <- subset(final_df3, Trial.Number == 50)
trials_1 <- trials_1 %>% rename(Response_Ax_1 = Response_Ax)
trials_48 <- trials_48 %>% rename(Response_Ax_48 = Response_Ax)
reshaped_data <- inner_join(trials_1, trials_48, by = "Random_ID")

response_matrix <- as.matrix(reshaped_data[, c("Response_Ax_1", "Response_Ax_48")])
#
# calculate ICC(3,1):
icc_result <- ICC(reshaped_data[, c("Response_Ax_1", "Response_Ax_48")])
sink("icc_output.txt")
print(icc_result)
# sink()

# # will comment the below to do it without lme model, also because the icc was strange did not include the estimate
# model <- lmer(Response_Ax ~ Response_H + (1 | Random_ID), data = final_df3)
#
# # Extract variance components
# var_components <- VarCorr(model)
# subject_variance <- as.numeric(var_components[1])
# residual_variance <- as.numeric(attr(var_components, "sc")^2)
#
# # Calculate ICC
# icc <- subject_variance / (subject_variance + residual_variance)
# print("lmer for the relationship between anxeity and mood")
# print(icc)
```


\newpage We will now look at the variance of anxiety ratings between and within subjects using a LME model: lmer(Anxiety ~ 1 + (1 | Random_ID), data = df) <br><br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
model <- lmer(Response_Ax ~ 1 + (1 | Random_ID), data = final_df3)

# Extract variance components
var_components <- as.data.frame(VarCorr(model))
subject_variance <- var_components[var_components$grp == "Random_ID", "vcov"]
residual_variance <- attr(VarCorr(model), "sc")^2

# Calculate ICC
icc <- subject_variance / (subject_variance + residual_variance)
print("lmer for anxiety with just the intercept")
print(icc)

confint(model)
```
Here’s a brief interpretation of each component for anxiety ratings:
<br>**.sig01 (Between-Subjects Variance)**: The variance between subjects (likely corresponding to Random_ID in our model) is estimated to be between 21.20765 and 32.51710 with 95% confidence. This means that there is a 95% chance that the true between-subject variance falls within this range.<br>
<br>**.sigma (Within-Subject Variance or Residual Variance):** The variance within subjects is estimated to be between 13.89811 and 14.76330 with 95% confidence. This variance captures the variation in responses that is not explained by the between-subject differences.<br>
<br>**(Intercept):** The overall mean (Intercept) of the anxiety rating across all subjects is estimated to be between 38.10115 and 53.96955 with 95% confidence. This is the average response you'd expect when all other variables in the model are held at their reference levels.
<br> The ICC value of **0.77** indicates that approximately 77% of the variability in the data can be attributed to differences between subjects. The higher the ICC, the more the total variability is due to between-subject differences rather than within-subject or residual error. An ICC of 0.77 is generally considered a high value, indicating good reliability between subjects.<br>

The relationship between the confidence intervals of the variance components and the ICC is that if the between-subject variance (.sig01) confidence interval is far from zero and much larger than the within-subject variance (.sigma), it supports a higher ICC, indicating strong group-level effects. If these confidence intervals were closer together, it would suggest less certainty about the strength of the grouping effect. In summary, the confidence intervals give us an estimate of the precision of our variance components, while the ICC gives us an estimate of the relative importance of the between-subject variability in the context of the total variability. A wide confidence interval for .sig01 might indicate that more data could be beneficial to precisely estimate the between-subject variability, while a narrow interval for .sigma suggests that the measurement error or within-subject variability is relatively well estimated.<br>



\newpage We will look at the variance of mood rating between and within subjects using a LME model: lmer(Mood ~ 1 + (1 | Random_ID), data = df) <br><br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
model <- lmer(Response_H ~ 1 + (1 | Random_ID), data = final_df3)
# confint(model)

# Extract variance components
var_components <- as.data.frame(VarCorr(model))
subject_variance <- var_components[var_components$grp == "Random_ID", "vcov"]
residual_variance <- attr(VarCorr(model), "sc")^2

# Calculate ICC
icc <- subject_variance / (subject_variance + residual_variance)
print("lmer for mood with just the intercept")
print(icc)

# Calculate the 95% confidence intervals for the model parameters
# This includes both fixed effects and variance components
confint_variance_components <- confint(model, method = "profile", level = 0.95)
print(confint_variance_components)
```
Here’s a brief interpretation of each component for mood ratings:

<br>**.sig01 (Between-Subjects Variance)**: The variance between subjects (likely corresponding to Random_ID in our model) is estimated to be between 18.09887 and 27.76344 with 95% confidence. This means that there is a 95% chance that the true between-subject variance falls within this range.<br>
<br>**.sigma (Within-Subject Variance or Residual Variance):** The variance within subjects is estimated to be between 12.88292 and 13.68491 with 95% confidence. This variance captures the variation in responses that is not explained by the between-subject differences.<br>
<br>**(Intercept):** The overall mean (Intercept) of the mood rating across all subjects is estimated to be between 42.43127 and 55.98455 with 95% confidence. This is the average response you'd expect when all other variables in the model are held at their reference levels.
<br> The ICC value of **0.74** indicates that approximately 74% of the variability in the data can be attributed to differences between subjects. The higher the ICC, the more the total variability is due to between-subject differences rather than within-subject or residual error. An ICC of 0.74 is generally considered a high value, indicating good reliability between subjects.

\newpage We now look at histograms for anxiety and mood: 
```{r echo=FALSE, , warning=FALSE, message=FALSE, out.extra='width=\\textwidth, height=\\textheight, keepaspectratio'}
p1 <- ggplot(final_df3, aes(x = Response_Ax)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black", alpha = 0.5) +
  geom_rug(sides = "b", color = "red", size = 0.5) +
  labs(title = "Histogram of Responses", x = "Anxiety Ratings", y = "Frequency") +
  theme_minimal()

print(p1)
```

```{r echo=FALSE, , warning=FALSE, message=FALSE, out.extra='width=\\textwidth, height=\\textheight, keepaspectratio'}
p2 <- ggplot(final_df3, aes(x = Response_H)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black", alpha = 0.5) +
  geom_rug(sides = "b", color = "red", size = 0.5) +
  labs(title = "Histogram of Responses", x = "Mood/Happiness Ratings", y = "Frequency") +
  theme_minimal()

print(p2)
```




```{r echo=FALSE, warning=FALSE, message=FALSE}
# subset first and last trials, since I had not removed the base line ratings here yet, it would be 3rd and 50th trials.
print("Correlation between first and last anxiety rating")
cor.test(final_df3[final_df3$Trial.Number==3, ]$Response_Ax, final_df3[final_df3$Trial.Number==50, ]$Response_Ax)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
print("Correlation between first and last mood rating")
cor.test(final_df3[final_df3$Trial.Number==3, ]$Response_H, final_df3[final_df3$Trial.Number==50, ]$Response_H)
```


\newpage
#### Pilot 5: prediction + feedback 
<br> 
**Goal:** To see whether positive PE can improve mood and anxiety. To do this we used two different versions of feedback (random vs non-random). If none of these succeed, we would need to create a third version where we take subjective predictions and histogram means into account to generate feedback.
Platform: MTurk

There were two different versions: <br>
**batch1)** With non-random feedback to generate positive, negative and zero PE's: https://app.gorilla.sc/admin/project/106374

**batch2)** With random feedback to generate positive, negative and zero PE's: https://app.gorilla.sc/admin/project/106055

Below we will be looking at the non-random feedback.
```{r echo=FALSE, warning=FALSE, message=FALSE}
df4 <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_AMT_pilot_fdbk_nrnd_typ/SUP_AMT_pilot_fdbk_nrnd_typ_v4/SUP_AMT_pilot_fdbk_nrnd_typ_v4_task_main.csv")
                                                                                 
df5 <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_AMT_pilot_fdbk_nrnd_typ/SUP_AMT_pilot_fdbk_nrnd_typ_v5/SUP_AMT_pilot_fdbk_nrnd_typ_v5_task_main.csv")


df5 <- rbind(df4, df5)
df5_mood <- subset(df5, Response.Type == "tooEarly")
df5 <- subset(df5, Response.Type == "response")
df5 <- subset(df5, Spreadsheet..Display == "Trials ")

# defining histogram means
df5$m_hist <- ifelse(df5$Spreadsheet..Histogram == "h1.png", 20,
                       ifelse(df5$Spreadsheet..Histogram == "h2.png", 29,
                              ifelse(df5$Spreadsheet..Histogram == "h3.png", 37,
                                     ifelse(df5$Spreadsheet..Histogram == "h4.png", 46,
                                            ifelse(df5$Spreadsheet..Histogram == "h5.png", 54,
                                                   ifelse(df5$Spreadsheet..Histogram == "h6.png", 63,
                                                          ifelse(df5$Spreadsheet..Histogram == "h7.png", 71,
                                                                 ifelse(df5$Spreadsheet..Histogram == "h8.png", 80, NA)))))))) 

```

```{r echo=FALSE, warning=FALSE, message=FALSE}
df5_pred <- subset(df5, Screen == "Prediction ")
df5_mood$Response <- as.numeric(as.character(df5_mood$Response))

df5_pred_trial_nr <- df5_pred %>%
  group_by(Random_ID) %>%
  mutate(trial_nr = row_number()) %>%
  ungroup()
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
# divide the df into three to look at people in smaller batches
unique_ids <- unique(df5_pred_trial_nr$Random_ID)
# Step 2: Create ID ranges
range1 <- unique_ids[1:35]
range2 <- unique_ids[36:71]
range3 <- unique_ids[72:113]
# Step 3: Subset the dataframe
subset1 <- df5_pred_trial_nr[df5_pred_trial_nr$Random_ID %in% range1, ]
subset2 <- df5_pred_trial_nr[df5_pred_trial_nr$Random_ID %in% range2, ]
subset3 <- df5_pred_trial_nr[df5_pred_trial_nr$Random_ID %in% range3, ]
# Now subset1, subset2, and subset3 have the data for the respective ID ranges
```

<br><br> The relationship between Expectation and Histogram means are presented in the three plots below for the 113 participants. The second plot shows this relationship across trials. This is important especially since in this task people also received feedback (which was either positive, negative, or neutral), and we can see whether receiving feedback over time made them ignore the histogram values when trying to make predictions. <br> 

<br>For subjects 1-35:<br>
```{r echo=FALSE, warning=FALSE, message=FALSE}
p1 <- ggplot(subset1, aes(x=Response, y=m_hist)) +
  geom_point(aes(color="Data Points")) +
    geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal()+
  xlab("Expectation") + 
  ylab("Histogram means")

print(p1)

subset1$Response <- as.numeric(as.character(subset1$Response))

subset1_pred_trial_nr <- subset1 %>%
  group_by(Random_ID) %>%
  mutate(trial_nr = row_number()) %>%
  ungroup()

subset1_long <- subset1_pred_trial_nr %>%
  pivot_longer(cols = c(Response, m_hist), names_to = "Metric", values_to = "Value") %>%
  mutate(Metric = recode(Metric,
                         Response = "Predictions",
                         m_hist = "Histograms"))

pt1 <- ggplot(subset1_long, aes(x = Trial.Number, y = Value, color = Metric, group = Metric)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Expectation across time",
       x = "Trial Number",
       y = "Expectation",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) # Separate plot for each ID, one column layout
print(pt1)

```

Participant SUPAMT35697 seems to have done the task twice somehow, probably by trying to modify the URL to see if they can do the whole experiment again but Gorilla would only allow them to restart the node (one node part experiment section e.g. surprise task, questionnaires, consent form etc). The same thing seems to have happened for participants SUPAMT97235, SUPAMT69675 in the other two plots.

<br>For subjects 36-71:<br>
```{r echo=FALSE, warning=FALSE, message=FALSE}
p2 <- ggplot(subset2, aes(x=Response, y=m_hist)) +
  geom_point(aes(color="Data Points")) +
    geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal()+
  xlab("Expectation") + 
  ylab("Histogram means")

print(p2)


subset2$Response <- as.numeric(as.character(subset2$Response))


subset2_pred_trial_nr <- subset2 %>%
  group_by(Random_ID) %>%
  mutate(trial_nr = row_number()) %>%
  ungroup()

subset2_long <- subset2_pred_trial_nr %>%
  pivot_longer(cols = c(Response, m_hist), names_to = "Metric", values_to = "Value") %>%
  mutate(Metric = recode(Metric,
                         Response = "Predictions",
                         m_hist = "Histograms"))

pt2 <- ggplot(subset2_long, aes(x = Trial.Number, y = Value, color = Metric, group = Metric)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Expectation across time",
       x = "Trial Number",
       y = "Expectation",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) # Separate plot for each ID, one column layout
print(pt2)

```

<br>For subjects 72-113:<br>
```{r echo=FALSE, warning=FALSE, message=FALSE}
p3 <- ggplot(subset3, aes(x=Response, y=m_hist)) +
  geom_point(aes(color="Data Points")) +
    geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal()+
  xlab("Expectation") + 
  ylab("Histogram means")

print(p3)

subset3$Response <- as.numeric(as.character(subset3$Response))


subset3_pred_trial_nr <- subset3 %>%
  group_by(Random_ID) %>%
  mutate(trial_nr = row_number()) %>%
  ungroup()

subset3_long <- subset3_pred_trial_nr %>%
  pivot_longer(cols = c(Response, m_hist), names_to = "Metric", values_to = "Value") %>%
  mutate(Metric = recode(Metric,
                         Response = "Predictions",
                         m_hist = "Histograms"))

pt3 <- ggplot(subset3_long, aes(x = Trial.Number, y = Value, color = Metric, group = Metric)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Expectation across time",
       x = "Trial Number",
       y = "Expectation",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) # Separate plot for each ID, one column layout
print(pt3)

```

<br><br><br>
Below we can see the average correlation and the histogram of the average:
<br><br><br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
df5_pred$Response <- as.numeric(as.character(df5_pred$Response))

correlations_mean <- df5_pred %>%
  group_by(Random_ID) %>%
  summarize(correlation = cor(Response, m_hist, use = "complete.obs"),
            .groups = 'drop')  # This line is used to avoid a grouped df as output

```

```{r echo=FALSE, warning=FALSE, message=FALSE}
m <- mean(correlations_mean$correlation)
print(paste("average of correlations:", m))
s <- sd(correlations_mean$correlation)
print(paste("sd of correlations:", s))

hist(correlations_mean$correlation)
```



```{r echo=FALSE, warning=FALSE, message=FALSE}
# divide the df into three to look at people in smaller batches
unique_ids_mood <- unique(df5_mood$Random_ID)
# Step 2: Create ID ranges
range1 <- unique_ids_mood[1:35]
range2 <- unique_ids_mood[36:71]
range3 <- unique_ids_mood[72:113]
# Step 3: Subset the dataframe
subset1 <- df5_mood[df5_mood$Random_ID %in% range1, ]
subset2 <- df5_mood[df5_mood$Random_ID %in% range2, ]
subset3 <- df5_mood[df5_mood$Random_ID %in% range3, ]

# Now subset1, subset2, and subset3 have the data for the respective ID ranges
```

<br> We will now look at mood and anxiety over time, but we cannot really compare the ratings on Gorilla with Prolific because the Gorilla one did have feedback, whereas the Prolific one did not. <br>


```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot(subset1, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Mood and anxiety across time",
       x = "Trial Number",
       y = "mood/happiness and anxiety",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) # Separate plot for each ID, one column layout

ggplot(subset2, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Mood and anxiety across time",
       x = "Trial Number",
       y = "mood/happiness and anxiety",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) # Separate plot for each ID, one column layout

ggplot(subset3, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Mood and anxiety across time",
       x = "Trial Number",
       y = "mood/happiness and anxiety",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) # Separate plot for each ID, one column layout

```

### Pilot 6: We repeated task with non-random feedback on Prolific to see whether the data quality would be better. Below you can see the results. Experiment: https://app.gorilla.sc/admin/experiment/147682/design, Task: https://app.gorilla.sc/admin/task/667140/editor?version=7

```{r echo=FALSE}
df6 <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_pilot_fdbk_nrnd_typ/SUP_PRF_pilot_fdbk_nrnd_typ_v3/SUP_PRF_pilot_fdbk_nrnd_typ_v3_task_main.csv")   # Prolific,non-random feedback, text only (no video/audio)

# if (!(identical(colnames(df1), colnames(df3)))) {
#   stop("The two dataframes have different columns or order of columns!")
# }

# let's now look at the second 34 subjects in df3 who had different historagms means and sds
df6_mood <- subset(df6, Response.Type == "tooEarly")
df6 <- subset(df6, Response.Type == "response")
df6 <- subset(df6, Spreadsheet..Display == "Trials ")

df6$m_hist <- ifelse(df6$Spreadsheet..Histogram == "h1.png", 20,
                       ifelse(df6$Spreadsheet..Histogram == "h2.png", 29,
                              ifelse(df6$Spreadsheet..Histogram == "h3.png", 37,
                                     ifelse(df6$Spreadsheet..Histogram == "h4.png", 46,
                                            ifelse(df6$Spreadsheet..Histogram == "h5.png", 54,
                                                   ifelse(df6$Spreadsheet..Histogram == "h6.png", 63,
                                                          ifelse(df6$Spreadsheet..Histogram == "h7.png", 71,
                                                                 ifelse(df6$Spreadsheet..Histogram == "h8.png", 80, NA))))))))  


```
<br> <br> 


```{r echo=FALSE, warning=FALSE, message=FALSE}
df6_pred <- subset(df6, Screen == "Prediction ")
df6_conf <- subset(df6, Screen == "Certainty rating ")
df6_pred$Response <- as.numeric(as.character(df6_pred$Response))
df6_mood$Response <- as.numeric(as.character(df6_mood$Response))


p <- ggplot(df6_pred, aes(x=Response, y=m_hist)) +
  geom_point(aes(color="Data Points")) +
    geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal()+
  xlab("Expectation") + 
  ylab("Histogram means")

print(p)
```

<br><br><br>
Below we can see the histogram means and expectation values across trials:
<br><br><br>


```{r echo=FALSE, warning=FALSE, message=FALSE}
df6_pred_trial_nr <- df6_pred %>%
  group_by(Random_ID) %>%
  mutate(trial_nr = row_number()) %>%
  ungroup()

df6_long <- df6_pred_trial_nr %>%
  pivot_longer(cols = c(Response, m_hist), names_to = "Metric", values_to = "Value") %>%
  mutate(Metric = recode(Metric, 
                         Response = "Predictions", 
                         m_hist = "Histograms"))

# Create the plot with facet_wrap
p <- ggplot(df6_long, aes(x = Trial.Number, y = Value, color = Metric, group = Metric)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Expectation across time",
       x = "Trial Number",
       y = "Expectation",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) # Separate plot for each ID, one column layout
print(p)

```
<br><br><br>
Below we can see the average correlation and the histogram of the average:
<br><br><br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
df6_pred$Response <- as.numeric(as.character(df6_pred$Response))

correlations_mean <- df6_pred %>%
  group_by(Random_ID) %>%
  summarize(correlation = cor(Response, m_hist, use = "complete.obs"),
            .groups = 'drop')  # This line is used to avoid a grouped df as output

```

```{r echo=FALSE, warning=FALSE, message=FALSE}
m <- mean(correlations_mean$correlation)
print(paste("average of correlations:", m))
s <- sd(correlations_mean$correlation)
print(paste("sd of correlations:", s))

hist(correlations_mean$correlation)
```

Now let's make plots for each subject that show how prediction, feedback, histogram mean, anxiety, mood, confidence rating, PE (feedback - histogram), subj_PE (feedback-prediction).


```{r echo=FALSE, warning=FALSE, message=FALSE}
# lets add the feedback in the same column as the rest of the data since they are all from 0-100 values and since we want a long format data

df6_raw <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_pilot_fdbk_nrnd_typ/SUP_PRF_pilot_fdbk_nrnd_typ_v3/SUP_PRF_pilot_fdbk_nrnd_typ_v3_task_main.csv")   # Prolific,non-random feedback, text only (no video/audio)

# create a new df6 that only keeps the columns we need

df6 <- df6_raw[, c("Trial.Number", "Display", "Screen", "Response.Type", "Response", 
                      "Reaction.Time", "Spreadsheet..Histogram", "Spreadsheet..Feedback", "Random_ID")]


df6 <- df6 %>%
  mutate(Response = as.numeric(as.character(Response))) %>%
  filter(!is.na(Response))

# add the histogram values depending on file name:
df6$m_hist <- ifelse(df6$Spreadsheet..Histogram == "h1.png", 20,
                       ifelse(df6$Spreadsheet..Histogram == "h2.png", 29,
                              ifelse(df6$Spreadsheet..Histogram == "h3.png", 37,
                                     ifelse(df6$Spreadsheet..Histogram == "h4.png", 46,
                                            ifelse(df6$Spreadsheet..Histogram == "h5.png", 54,
                                                   ifelse(df6$Spreadsheet..Histogram == "h6.png", 63,
                                                          ifelse(df6$Spreadsheet..Histogram == "h7.png", 71,
                                                                 ifelse(df6$Spreadsheet..Histogram == "h8.png", 80, NA))))))))  




# get rid of the rows we don't need: practice runs, continue button presses etc. and only keep Trials, Anxiety and Mood that include all variables we are interested in:
df6 <- df6 %>%
  filter(
    (Display == "Trials ") |
    (Display == "Anxiety " & !Trial.Number %in% c(1, 2)) |
    (Display == "Mood " & !Trial.Number %in% c(1, 2)) 
  )

# setting Mood and Anxiety trial numbers to match the trials starting from 1 (since we removed the baseline ones above)
df6$Trial.Number <- ifelse(df6$Display == 'Mood ' | df6$Display == 'Anxiety ', df6$Trial.Number - 2, df6$Trial.Number)
df6$Display <- ifelse(df6$Display == 'Mood ' | df6$Display == 'Anxiety ', "Trials", df6$Display)

# renaming the feedback column to fdbk
names(df6)[names(df6) == 'Spreadsheet..Feedback'] <- 'fdbk'

# Now let's create columns for PE (fdbk-hist) and Subj_PE (fdbk_Prediction)

df6$SubjPE <- ifelse(df6$Screen == "Prediction ", df6$fdbk - df6$Response, NA)
df6$PE <- ifelse(df6$Screen == "Prediction ", df6$fdbk - df6$m_hist, NA)
# to keep just one repetition of feedback and mean histogram per trial per subject 
# and replace the rest with NA so that when we want to convert to long format we won't have duplicates
df6$fdbk <- ifelse(df6$Screen == "Prediction ", df6$fdbk, NA)
df6$m_hist <- ifelse(df6$Screen == "Prediction ", df6$m_hist, NA)


long_df6 <- df6 %>%
  select(Random_ID, Trial.Number, fdbk, m_hist, PE, SubjPE) %>%
  pivot_longer(cols = c(fdbk, m_hist, PE, SubjPE),
               names_to = "Screen",
               values_to = "Response")


# This will keep only the rows where 'Response' is not NA
long_df6 <- long_df6[!is.na(long_df6$Response), ]

  
# Selecting relevant columns from the original df6
df6 <- df6 %>%
  select(-c(fdbk, m_hist, PE, SubjPE))

# Binding the rows together
df6 <- bind_rows(df6, long_df6)

```


```{r echo=FALSE, warning=FALSE, message=FALSE}

random_ids <- c("SUPPRF18834", "SUPPRF41746", "SUPPRF51534", "SUPPRF77371", "SUPPRF20648", 
                "SUPPRF71510", "SUPPRF43420", "SUPPRF54374", "SUPPRF62013", "SUPPRF96180", 
                "SUPPRF30203", "SUPPRF16716", "SUPPRF51230", "SUPPRF43536", "SUPPRF13138", 
                "SUPPRF95014", "SUPPRF98941", "SUPPRF77780", "SUPPRF94218", "SUPPRF69479")

df6_s1 <- subset(df6, Random_ID == "SUPPRF18834")
df6_s2 <- subset(df6, Random_ID == "SUPPRF69479")
df6_s3 <- subset(df6, Random_ID == "SUPPRF51534")
df6_s4 <- subset(df6, Random_ID == "SUPPRF77371")
df6_s5 <- subset(df6, Random_ID == "SUPPRF20648")
df6_s6 <- subset(df6, Random_ID == "SUPPRF71510")
df6_s7 <- subset(df6, Random_ID == "SUPPRF43420")
df6_s8 <- subset(df6, Random_ID == "SUPPRF94218")
df6_s9 <- subset(df6, Random_ID == "SUPPRF41746")
df6_s10 <- subset(df6, Random_ID == "SUPPRF54374")
df6_s11 <- subset(df6, Random_ID == "SUPPRF62013")
df6_s12 <- subset(df6, Random_ID == "SUPPRF96180")
df6_s13 <- subset(df6, Random_ID == "SUPPRF30203")
df6_s14 <- subset(df6, Random_ID == "SUPPRF16716")
df6_s15 <- subset(df6, Random_ID == "SUPPRF51230")
df6_s16 <- subset(df6, Random_ID == "SUPPRF43536")
df6_s17 <- subset(df6, Random_ID == "SUPPRF13138")
df6_s18 <- subset(df6, Random_ID == "SUPPRF95014")
df6_s19 <- subset(df6, Random_ID == "SUPPRF98941")
df6_s20 <- subset(df6, Random_ID == "SUPPRF77780")

list_of_df6s <- list(df6_s1, df6_s2, df6_s3, df6_s4, df6_s5, df6_s6, df6_s7, df6_s8, df6_s9, df6_s10, 
                    df6_s11, df6_s12, df6_s13, df6_s14, df6_s15, df6_s16, df6_s17, df6_s18, df6_s19, df6_s20)

plot_function <- function(df6, title) {
  p <- ggplot(df6, aes(x = Trial.Number, y = Response, color = Screen, group = Screen)) +
    geom_line() +
    theme_minimal() +
    labs(title = title,  # Set the title to the Random_ID
         x = "Trial Number",
         y = "Mood Ratings/Expectations/ PE",
         color = "") +
    facet_wrap(~ Screen, ncol = 2) +
    geom_hline(yintercept = 0)
  
  return(p)
}

# Use Map or mapply to apply the plot_function to each data frame and title in the list
list_of_plots <- Map(plot_function, list_of_df6s, random_ids)

# for (plot in list_of_plots) {
#   print(plot)
# }

print(list_of_plots[[1]])
print(list_of_plots[[2]])
print(list_of_plots[[3]])
print(list_of_plots[[4]])
print(list_of_plots[[5]])
print(list_of_plots[[6]])
print(list_of_plots[[7]])
print(list_of_plots[[8]])
print(list_of_plots[[9]])
print(list_of_plots[[10]])
print(list_of_plots[[11]])
print(list_of_plots[[12]])
print(list_of_plots[[13]])
print(list_of_plots[[14]])
print(list_of_plots[[15]])
print(list_of_plots[[16]])
print(list_of_plots[[17]])
print(list_of_plots[[18]])
print(list_of_plots[[19]])
print(list_of_plots[[20]])

```

```{r echo=FALSE, warning=FALSE, message=FALSE}
# if you need to correlate variables using the long dataset, it is very simple
df6$Response <- as.numeric(df6$Response)
# cor(df6[df6$Screen == "PE", ]$Response, 
#     df6[df6$Screen == "SubjPE", ]$Response)

# and it is also simple if you want to do this by subject
# unique_ids <- unique(df6$Random_ID)  # get the unique IDs
# cors_by_id <- numeric(length(unique_ids))  # initialize a numeric vector to store correlations

# List of IDs
ids <- c("SUPPRF18834", "SUPPRF41746", "SUPPRF51534", "SUPPRF77371", "SUPPRF20648", 
         "SUPPRF71510", "SUPPRF43420", "SUPPRF54374", "SUPPRF62013", "SUPPRF96180", 
         "SUPPRF30203", "SUPPRF16716", "SUPPRF51230", "SUPPRF43536", "SUPPRF13138", 
         "SUPPRF95014", "SUPPRF98941", "SUPPRF77780", "SUPPRF94218", "SUPPRF69479")

cors_by_id <- numeric(length(ids))

# Loop through each ID
for (i in seq_along(ids)) {
  # Subset data for current ID
  current_id <- ids[i]
  d_PE <- df6[df6$Screen == "PE" & df6$Random_ID == current_id, ]$Response
  d_SubjPE <- df6[df6$Screen == "SubjPE" & df6$Random_ID == current_id, ]$Response
  
  # Calculate correlation for the current ID
  cors_by_id[i] <- cor(d_PE, d_SubjPE, use = "complete.obs")  # 'complete.obs' to ignore NA values
}

# Print the correlations
# print(cors_by_id)


```

\newpage We now look at the relationship between PE (feedback - histogram_mean) and SubjPE (feedback - prediction):

```{r echo=FALSE, warning=FALSE, message=FALSE}
# looking at the relationship between PE and SubjPE
df6_PE <- subset(df6, Screen == "PE")
names(df6_PE)[names(df6_PE) == "Screen"] <- "Screen_PE"
names(df6_PE)[names(df6_PE) == "Response"] <- "Response_PE"


df6_SubjPE <- subset(df6, Screen == "SubjPE")
names(df6_SubjPE)[names(df6_SubjPE) == "Screen"] <- "Screen_SubjPE"
names(df6_SubjPE)[names(df6_SubjPE) == "Response"] <- "Response_SubjPE"

merged_df6 <- inner_join(df6_SubjPE, df6_PE, by = c("Random_ID", "Trial.Number"))


# Calculate correlation by Random_ID
correlations <- merged_df6 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_PE, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between PE and SubjPE:", average_correlation)
print(message_to_print)

ggplot(merged_df6, aes(x=Response_PE, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("PE: feedback - hist_mean") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6))  # you can change the size value as needed



# # Calculate Spearman rank correlation by Random_ID
# correlations <- merged_df6 %>%
#   group_by(Random_ID) %>%
#   summarise(correlation = cor(Response_PE, Response_SubjPE, method = "spearman", use = "complete.obs")) %>%
#   mutate(label = paste("Rho = ", round(correlation, digits = 2)))  # create a label for the plot
# 
# ggplot(merged_df6, aes(x=Response_PE, y=Response_SubjPE)) +
#   geom_point(aes(color="Data Points")) +
#   geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +
#   labs(color="Legend") +
#   facet_wrap(~ Random_ID, scales = "free") +
#   theme_minimal() +
#   xlab("PE: feedback - hist_mean") +
#   ylab("SubjPE: feedback - prediction") +
#   # Add the correlation labels, with bold text
#   geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), 
#             hjust=1.1, vjust=1.1, size=3.5, fontface = "bold", inherit.aes=FALSE)


```


\newpage Let's now look at the relationship between SubjPE and Anxiety:

```{r echo=FALSE, warning=FALSE, message=FALSE}
df6_Anxious <- subset(df6, Screen == "Anxious")
names(df6_Anxious)[names(df6_Anxious) == "Screen"] <- "Screen_Ax"
names(df6_Anxious)[names(df6_Anxious) == "Response"] <- "Response_Ax"

df6_Happy <- subset(df6, Screen == "Happy")
names(df6_Happy)[names(df6_Happy) == "Screen"] <- "Screen_H"
names(df6_Happy)[names(df6_Happy) == "Response"] <- "Response_H"

final_df6 <- merged_df6 %>%
  inner_join(df6_Anxious, by = c("Random_ID", "Trial.Number")) %>%
  inner_join(df6_Happy, by = c("Random_ID", "Trial.Number"))

# Calculate correlation by Random_ID for anxiety
correlations <- final_df6 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and SubjPE:", average_correlation)
print(message_to_print)


ggplot(final_df6, aes(x=Response_Ax, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6))  # you can change the size value as needed

```

\newpage Below we can see the relationship between SubjPE and Mood/Happiness:

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Calculate correlation by Random_ID for mood
correlations <- final_df6 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Happiness and SubjPE:", average_correlation)
print(message_to_print)

ggplot(final_df6, aes(x=Response_H, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Mood/Happiness") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6))  # you can change the size value as needed

```

\newpage Now we will exclude some people who had given the same answers throughout the task and repeat everything again without them to see whether the group correlation changes for anxiety and mood. Below we can see the correlation between anxiety and SubjPE:

```{r echo=FALSE, warning=FALSE, message=FALSE}
# 1) Exclude the following people as they were outliers/gave same answers: SUPPRF71510, SUPPRF54374, SUPPRF62013, SUPPRF94218
# 2) Have them having the same x and y-axis values to be more comparable
# 3) see if the mean correlation is significantly different from zero
# 4) do LME model with H or A ~ PE, Random_ID (random effect to get random intercept), PE (random effect to get random intercept)

# Create a vector of IDs to exclude
ids_to_exclude <- c("SUPPRF71510", "SUPPRF54374", "SUPPRF62013", "SUPPRF94218")

# Subset the data
subset_df6 <- final_df6[!final_df6$Random_ID %in% ids_to_exclude, ]

# Calculate correlation by Random_ID for anxiety
correlations_Ax_excludedoutliers <- subset_df6 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and SubjPE after excluding 4 outliers:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(subset_df6$Response_Ax, na.rm = TRUE)
y_range <- range(subset_df6$Response_SubjPE, na.rm = TRUE)


ggplot(subset_df6, aes(x=Response_Ax, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations_Ax_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))


```

\newpage The next plot shows the same relationship for mood/happiness and SubjPE:
```{r echo=FALSE, warning=FALSE, message=FALSE}
# Calculate correlation by Random_ID for anxiety
# Calculate correlation by Random_ID for anxiety
correlations_H_excludedoutliers <- subset_df6 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_H_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between happiness and SubjPE after excluding 4 outliers:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(subset_df6$Response_H, na.rm = TRUE)
y_range <- range(subset_df6$Response_SubjPE, na.rm = TRUE)


ggplot(subset_df6, aes(x=Response_H, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Happiness/Mood") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations_H_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```

\newpage We now will look whether the average correlations are significantly different from zero for both anxiety and mood:

```{r echo=FALSE, warning=FALSE, message=FALSE}

print("corr Anxiety and SubjPE")

t_test_result <- t.test(correlations_Ax_excludedoutliers$correlation, mu = 0) 
print(t_test_result)

print("corr happiness and SubjPE")
t_test_result <- t.test(correlations_H_excludedoutliers$correlation, mu = 0) 
print(t_test_result)

```

\newpage I will now exclude subject SUPPRF16716 who rated always 0 for happiness and repeat the correlations again. The plot below shows the relationship between Anxiety and SubjPE:

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Create a vector of IDs to exclude'
ids_to_exclude <- c("SUPPRF71510", "SUPPRF54374", "SUPPRF62013", "SUPPRF94218", "SUPPRF16716")

# Subset the data
subset_df6 <- final_df6[!final_df6$Random_ID %in% ids_to_exclude, ]

# Calculate correlation by Random_ID for anxiety
correlations_Ax_excludedoutliers <- subset_df6 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and SubjPE after excluding 4 outliers:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(subset_df6$Response_Ax, na.rm = TRUE)
y_range <- range(subset_df6$Response_SubjPE, na.rm = TRUE)


ggplot(subset_df6, aes(x=Response_Ax, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations_Ax_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))


```


\newpage The next plot shows the same relationship for mood/happiness and SubjPE:
```{r echo=FALSE, warning=FALSE, message=FALSE}
# Calculate correlation by Random_ID for anxiety
correlations_H_excludedoutliers <- subset_df6 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_H_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between happiness and SubjPE after excluding 4 outliers:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(subset_df6$Response_H, na.rm = TRUE)
y_range <- range(subset_df6$Response_SubjPE, na.rm = TRUE)


ggplot(subset_df6, aes(x=Response_H, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Happiness/Mood") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations_H_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```

\newpage We now will look whether the average correlations are significantly different from zero for both anxiety and mood after excluding one more subject:

```{r echo=FALSE, warning=FALSE, message=FALSE}

print("corr Anxiety and SubjPE")

t_test_result <- t.test(correlations_Ax_excludedoutliers$correlation, mu = 0) 
print(t_test_result)

print("corr happiness and SubjPE")
t_test_result <- t.test(correlations_H_excludedoutliers$correlation, mu = 0) 
print(t_test_result)

```
\newpage We now will run everything again but this time using the objectibe PE (feedback - histogram_mean) instead of the subjecive one (feedback - prediction)

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Create a vector of IDs to exclude'
ids_to_exclude <- c("SUPPRF71510", "SUPPRF54374", "SUPPRF62013", "SUPPRF94218", "SUPPRF16716")

# Subset the data
subset_df6 <- final_df6[!final_df6$Random_ID %in% ids_to_exclude, ]

# Calculate correlation by Random_ID for anxiety
correlations_Ax_excludedoutliers <- subset_df6 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_PE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and PE after excluding 4 outliers:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(subset_df6$Response_Ax, na.rm = TRUE)
y_range <- range(subset_df6$Response_PE, na.rm = TRUE)


ggplot(subset_df6, aes(x=Response_Ax, y=Response_PE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("PE: feedback - hist_m") +
  # Add the correlation labels
  geom_text(data=correlations_Ax_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))


```

\newpage This plot shows the relationship between PE and mood:

```{r echo=FALSE, warning=FALSE, message=FALSE}
# Calculate correlation by Random_ID for anxiety
correlations_H_excludedoutliers <- subset_df6 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_PE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_H_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between happiness and PE after excluding 4 outliers:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(subset_df6$Response_H, na.rm = TRUE)
y_range <- range(subset_df6$Response_PE, na.rm = TRUE)


ggplot(subset_df6, aes(x=Response_H, y=Response_PE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Happiness/Mood") + 
  ylab("PE: feedback - hist_m") +
  # Add the correlation labels
  geom_text(data=correlations_H_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))


```


```{r echo=FALSE, warning=FALSE, message=FALSE}

print("corr Anxiety and  PE")

t_test_result <- t.test(correlations_Ax_excludedoutliers$correlation, mu = 0) 
print(t_test_result)

print("corr happiness and PE")
t_test_result <- t.test(correlations_H_excludedoutliers$correlation, mu = 0) 
print(t_test_result)

```

\newpage 
# ICC for anxiety pilot 6

we will now look at the ICC outcome for anxiety
<br> The ICC for anxiety is 0.63, which is moderate according to guidelines by Koo and Li (2016):<br>
<br> below 0.50: poor<br>
<br>between 0.50 and 0.75: moderate<br>
<br>between 0.75 and 0.90: good<br>
<br>above 0.90: excellent<br>
```{r echo=FALSE, warning=FALSE, message=FALSE}
library(irr)
library(lme4)
library(psych)

# change name to model null (same for all others)
model <- lme4::lmer(Response_Ax ~ 1 + (1 | Random_ID), data = final_df6)
# Extract variance components
var_components <- VarCorr(model)
subject_variance <- as.numeric(var_components[1])
residual_variance <- as.numeric(attr(var_components, "sc")^2)

# Calculate ICC
icc <- subject_variance / (subject_variance + residual_variance)
print("lmer for anxiety with just the intercept")
print(icc)

confint(model)
```


\newpage 
# ICC for mood pilot 6

The ICC for mood is 0.42, which is lower than anxiety and is actually  within the poor category, according to guidelines by Koo and Li (2016):<br>
<br> below 0.50: poor<br>
<br>between 0.50 and 0.75: moderate<br>
<br>between 0.75 and 0.90: good<br>
<br>above 0.90: excellent<br>
```{r echo=FALSE, warning=FALSE, message=FALSE}
# change name to model null (same for all others)
model <- lme4::lmer(Response_H ~ 1 + (1 | Random_ID), data = final_df6)
# Extract variance components
var_components <- VarCorr(model)
subject_variance <- as.numeric(var_components[1])
residual_variance <- as.numeric(attr(var_components, "sc")^2)

# Calculate ICC
icc <- subject_variance / (subject_variance + residual_variance)
print("lmer for mood with just the intercept")
print(icc)

confint(model)
```



\newpage <font size="3"> ### Pilot 7: The following pilot had a non-randomly provided feedback, with one bigger positive feedback per participant to increase the size of positive PE to see how it would influence mood and anxiety, using the following experiment:https://app.gorilla.sc/admin/experiment/147683/design and task: pilot_fdbk_nrand_bigPE_typing_novid </font>

<br> <br> For this study, we did not screen for social anxiety but need to see their social anxiety scores to see how many are bigger than or equal the threshold of 6. The data below includes the additional 20 people we have tested (we have 37 people now, we need to approve 3 other people manually, will add them later).

<font size="3"> It may also be interesting to look at the relationship between the correlation between anxiety and PE, with mini-SPIN score to see how the levels of social anxiety may influence this relationship </font>
<br> <br> 
```{r echo=FALSE, warning=FALSE, message=FALSE}
df7 <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_pilot_fdbk_bignrnd_typ/SUP_PRF_pilot_fdbk_bignrnd_typ_v3/SUP_PRF_pilot_fdbk_bignrnd_typ_v3_task_main.csv")
# Prolific,non-random feedback, text only (no video/audio) with bigger PE, once per judge
# This includes the additional 20 people we tested

df7_mood <- subset(df7, Response.Type == "tooEarly")
df7 <- subset(df7, Response.Type == "response")
df7 <- subset(df7, Spreadsheet..Display == "Trials ")

# defining histogram means
df7$m_hist <- ifelse(df7$Spreadsheet..Histogram == "h1.png", 20,
                       ifelse(df7$Spreadsheet..Histogram == "h2.png", 29,
                              ifelse(df7$Spreadsheet..Histogram == "h3.png", 37,
                                     ifelse(df7$Spreadsheet..Histogram == "h4.png", 46,
                                            ifelse(df7$Spreadsheet..Histogram == "h5.png", 54,
                                                   ifelse(df7$Spreadsheet..Histogram == "h6.png", 63,
                                                          ifelse(df7$Spreadsheet..Histogram == "h7.png", 71,
                                                                 ifelse(df7$Spreadsheet..Histogram == "h8.png", 80, NA))))))))

```

<br> 
<font size="3"> The figure below shows the relationship between histogram means and the predictions.</font>
<br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
df7_pred <- subset(df7, Screen == "Prediction ")
df7_conf <- subset(df7, Screen == "Certainty rating ")
df7_pred$Response <- as.numeric(as.character(df7_pred$Response))
df7_mood$Response <- as.numeric(as.character(df7_mood$Response))

# Calculate correlation by Random_ID for anxiety
correlations <- df7_pred %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response, m_hist, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between prediction and m_hist:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(df7_pred$Response, na.rm = TRUE)
y_range <- range(df7_pred$m_hist, na.rm = TRUE)


ggplot(df7_pred, aes(x=Response, y=m_hist)) +
  geom_point(aes(color="Data Points"),size = 0.5) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Expectation") + 
  ylab("Histogram means") +
  xlim(c(0, 100)) +  # Set your desired x limits
  ylim(c(0, 100)) +  # Set your desired y limits
  # Add the correlation labels
  geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold",    
             inherit.aes=FALSE) +
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(20, 100, by = 20), limits = c(20, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```

<br><br><br>
<font size="3"> Below we can see the histogram means and expectation values across trials:</font>
<br><br><br>


```{r echo=FALSE, warning=FALSE, message=FALSE}
df7_pred_trial_nr <- df7_pred %>%
  group_by(Random_ID) %>%
  mutate(trial_nr = row_number()) %>%
  ungroup()

df7_long <- df7_pred_trial_nr %>%
  pivot_longer(cols = c(Response, m_hist), names_to = "Metric", values_to = "Value") %>%
  mutate(Metric = dplyr::recode(Metric, 
                         Response = "Predictions", 
                         m_hist = "Histograms"))

# Create the plot with facet_wrap
ggplot(df7_long, aes(x = Trial.Number, y = Value, color = Metric, group = Metric)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Expectation across time",
       x = "Trial Number",
       y = "Expectation",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) + # Separate plot for each ID, one column layout
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 50, by = 10), limits = c(0, 50)) +
  scale_y_continuous(breaks = seq(20, 100, by = 20), limits = c(20, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))
```
<br><br><br>
<br> 
<font size="3"> we will now make the same plots for mood (asking people how happy they are) and anxiety </font>
<br>

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Create the plot with facet_wrap

ggplot(df7_mood, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Mood and anxiety across time",
       x = "Trial Number",
       y = "mood/happiness and anxiety",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) + # Separate plot for each ID, one column layout
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 50, by = 10), limits = c(0, 50)) +
  scale_y_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```


```{r echo=FALSE, warning=FALSE, message=FALSE}
df7_pred$Response <- as.numeric(as.character(df7_pred$Response))

correlations_mean <- df7_pred %>%
  group_by(Random_ID) %>%
  summarize(correlation = cor(Response, m_hist, use = "complete.obs"),
            .groups = 'drop')  # This line is used to avoid a grouped df7 as output

```

<br><br><br>
<font size="3"> Below we can see the average correlation and the histogram of the average. There were 2 people with random answers not taking the histograms into account, we can see them on the left side of the distribution having a negative or 0 correlation. </font>
<br><br><br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
m <- mean(correlations_mean$correlation)
print(paste("average of correlations:", m))
s <- sd(correlations_mean$correlation)
print(paste("sd of correlations:", s))

hist(correlations_mean$correlation)
```

Now let's make plots for each subject that show how prediction, feedback, histogram mean, anxiety, mood, confidence rating, PE (feedback - histogram), subj_PE (feedback-prediction).


```{r echo=FALSE, warning=FALSE, message=FALSE}

df7_raw <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_pilot_fdbk_bignrnd_typ/SUP_PRF_pilot_fdbk_bignrnd_typ_v3/SUP_PRF_pilot_fdbk_bignrnd_typ_v3_task_main.csv")   # Prolific,non-random feedback, text only (no video/audio) with bigger PE, once per judge, 37 (40 for now) subjects

# create a new df7 that only keeps the columns we need
df7 <- df7_raw[, c("Trial.Number", "Display", "Screen", "Response.Type", "Response", 
                      "Reaction.Time", "Spreadsheet..Histogram", "Spreadsheet..Feedback", "Random_ID")]


df7 <- df7 %>%
  mutate(Response = as.numeric(as.character(Response))) %>%
  dplyr::filter(!is.na(Response))

# add the histogram values depending on file name:
df7$m_hist <- ifelse(df7$Spreadsheet..Histogram == "h1.png", 20,
                       ifelse(df7$Spreadsheet..Histogram == "h2.png", 29,
                              ifelse(df7$Spreadsheet..Histogram == "h3.png", 37,
                                     ifelse(df7$Spreadsheet..Histogram == "h4.png", 46,
                                            ifelse(df7$Spreadsheet..Histogram == "h5.png", 54,
                                                   ifelse(df7$Spreadsheet..Histogram == "h6.png", 63,
                                                          ifelse(df7$Spreadsheet..Histogram == "h7.png", 71,
                                                                 ifelse(df7$Spreadsheet..Histogram == "h8.png", 80, NA))))))))  


# get rid of the rows we don't need: practice runs, continue button presses etc. and only keep Trials, Anxiety and Mood that include all variables we are interested in:
df7 <- df7 %>%
  dplyr::filter(
    (Display == "Trials ") |
    (Display == "Anxiety " & !Trial.Number %in% c(1, 2)) |
    (Display == "Mood " & !Trial.Number %in% c(1, 2)) 
  )

# setting Mood and Anxiety trial numbers to match the trials starting from 1 (since we removed the baseline ones above)
df7$Trial.Number <- ifelse(df7$Display == 'Mood ' | df7$Display == 'Anxiety ', df7$Trial.Number - 2, df7$Trial.Number)
df7$Display <- ifelse(df7$Display == 'Mood ' | df7$Display == 'Anxiety ', "Trials", df7$Display)

# renaming the feedback column to fdbk
names(df7)[names(df7) == 'Spreadsheet..Feedback'] <- 'fdbk'

# Now let's create columns for PE (fdbk-hist) and Subj_PE (fdbk_Prediction)
df7$SubjPE <- ifelse(df7$Screen == "Prediction ", df7$fdbk - df7$Response, NA)
df7$PE <- ifelse(df7$Screen == "Prediction ", df7$fdbk - df7$m_hist, NA)
# to keep just one repetition of feedback and mean histogram per trial per subject 
# and replace the rest with NA so that when we want to convert to long format we won't have duplicates
df7$fdbk <- ifelse(df7$Screen == "Prediction ", df7$fdbk, NA)
df7$m_hist <- ifelse(df7$Screen == "Prediction ", df7$m_hist, NA)


long_df7 <- df7 %>%
  dplyr::select(Random_ID, Trial.Number, fdbk, m_hist, PE, SubjPE) %>%
  pivot_longer(cols = c(fdbk, m_hist, PE, SubjPE),
               names_to = "Screen",
               values_to = "Response")


# This will keep only the rows where 'Response' is not NA
long_df7 <- long_df7[!is.na(long_df7$Response), ]

  
# Selecting relevant columns from the original df7
df7 <- df7 %>%
  dplyr::select(-c(fdbk, m_hist, PE, SubjPE))

# Binding the rows together
df7 <- bind_rows(df7, long_df7)

```


```{r echo=FALSE, warning=FALSE, message=FALSE}

random_ids <- unique(df7$Random_ID)

list_of_df7s <- list()

for (i in seq_along(random_ids)) {
  x <- random_ids[i]  # Get the current value from random_ids
  df7_si <- subset(df7, Random_ID == x)  # Create the subset
  list_of_df7s[[paste0("df7_s", i)]] <- df7_si  # Add the subset to list_of_df7s
}

plot_function <- function(df7, title) {
  p <- ggplot(df7, aes(x = Trial.Number, y = Response, color = Screen, group = Screen)) +
    geom_line() +
    theme_minimal() +
    labs(title = title,  # Set the title to the Random_ID
         x = "Trial Number",
         y = "Mood Ratings/Expectations/ PE",
         color = "") +
    facet_wrap(~ Screen, ncol = 2) +
    geom_hline(yintercept = 0)
  
  return(p)
}

# Use Map or mapply to apply the plot_function to each data frame and title in the list
list_of_plots <- Map(plot_function, list_of_df7s, random_ids)


for (i in seq_along(list_of_plots)) {
  print(list_of_plots[[i]])
}


```

```{r echo=FALSE, warning=FALSE, message=FALSE}
# if you need to correlate variables using the long dataset, it is very simple
# df7$Response <- as.numeric(df7$Response)
# 
# cors_by_id <- numeric(length(random_ids))
# 
# # Loop through each ID
# for (i in seq_along(random_ids)) {
#   # Subset data for current ID
#   current_id <- random_ids[i]
#   d_PE <- df7[df7$Screen == "PE" & df7$Random_ID == current_id, ]$Response
#   d_SubjPE <- df7[df7$Screen == "SubjPE" & df7$Random_ID == current_id, ]$Response
#   
#   # Calculate correlation for the current ID
#   cors_by_id[i] <- cor(d_PE, d_SubjPE, use = "complete.obs")  # 'complete.obs' to ignore NA values
# }

# Print the correlations
# print(cors_by_id)

```


\newpage We now look at the relationship between PE (feedback - histogram_mean) and SubjPE (feedback - prediction):

```{r echo=FALSE, warning=FALSE, message=FALSE}
# looking at the relationship between PE and SubjPE
df7_PE <- subset(df7, Screen == "PE")
names(df7_PE)[names(df7_PE) == "Screen"] <- "Screen_PE"
names(df7_PE)[names(df7_PE) == "Response"] <- "Response_PE"


df7_SubjPE <- subset(df7, Screen == "SubjPE")
names(df7_SubjPE)[names(df7_SubjPE) == "Screen"] <- "Screen_SubjPE"
names(df7_SubjPE)[names(df7_SubjPE) == "Response"] <- "Response_SubjPE"

merged_df7 <- inner_join(df7_SubjPE, df7_PE, by = c("Random_ID", "Trial.Number"))


# Calculate correlation by Random_ID
correlations <- merged_df7 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_PE, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between PE and SubjPE:", average_correlation)
print(message_to_print)

ggplot(merged_df7, aes(x=Response_PE, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("PE: feedback - hist_mean") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
     # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(-20, 20, by = 5), limits = c(-20, 20)) +
  scale_y_continuous(breaks = seq(-50, 50, by = 10), limits = c(-50, 50))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```

\newpage Let's now look at the relationship between SubjPE and Anxiety:

```{r echo=FALSE, warning=FALSE, message=FALSE}
# looking at the relationship between PE, SubjPE, anxiety and mood:
df7_Anxious <- subset(df7, Screen == "Anxious")
names(df7_Anxious)[names(df7_Anxious) == "Screen"] <- "Screen_Ax"
names(df7_Anxious)[names(df7_Anxious) == "Response"] <- "Response_Ax"

df7_Happy <- subset(df7, Screen == "Happy")
names(df7_Happy)[names(df7_Happy) == "Screen"] <- "Screen_H"
names(df7_Happy)[names(df7_Happy) == "Response"] <- "Response_H"

final_df7 <- merged_df7 %>%
  inner_join(df7_Anxious, by = c("Random_ID", "Trial.Number")) %>%
  inner_join(df7_Happy, by = c("Random_ID", "Trial.Number"))


# Calculate correlation by Random_ID for anxiety
correlations <- final_df7 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and SubjPE:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(final_df7$Response_Ax, na.rm = TRUE)
y_range <- range(final_df7$Response_SubjPE, na.rm = TRUE)

ggplot(final_df7, aes(x=Response_Ax, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
     # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```
I will remove subject "SUPPRF67412" who has always scored 0 regardless of the feedback and see whether the results change.Adding more people did not increase the negative correlation, it may be due to some people have a correlation close to 0 (somehow they have almost 0 SubjPE, so no big variation in the y-axis leading to a zero correlation with anxiety, e.g. subjects SUPPRF94460, SUPPRF97235, SUPPRF55923, SUPPRF44350 etc.), so looking at random feedback and biggest PE will be interesting since we won't be use histograms anymore in our feedback calculation. I will look at the random feedback after looking at the biggest PE data.

<br><br>
Some thoughts: maybe we don’t always want prediction be close to feedback if it creates close to zero PE’s across all trials and won’t allow us to look at its impact on emotions and mood? In other words, we don’t want a perfect correlation between histogram and prediction to be able to study the impact of prediction error on mood and anxiety better.Let’s see how the random and biggest PE trials look like, would it be meaningful to separate different types of PE’s?
<br>

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Create a vector of IDs to exclude
ids_to_exclude <- c("SUPPRF67412")

# Subset the data
subset_df7 <- final_df7[!final_df7$Random_ID %in% ids_to_exclude, ]

# Calculate correlation by Random_ID for anxiety
correlations_Ax_excludedoutliers <- subset_df7 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and SubjPE after excluding 1 outlier:", average_correlation)
print(message_to_print)

ggplot(subset_df7, aes(x=Response_Ax, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations_Ax_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))


```
After removing this subject, the correlation becomes -0.15 from an average r of -0.14. <div style="background-color: #FFFF00"> We may need to look at their mini-SPIN scores, and also think about Georgina's comment about how we are asking the anxiety question, people, especially younger people may use the word "nervous" rather than "anxious".</div>

\newpage Below we see the relationship between anxiety and mood per subject. 
<br> Some people have a positive correlation which does not make sense (e.g. subjects SUBPRF45081, SUBPRF55923,less strong SUBPRF61088).<br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
# Calculate correlation by Random_ID for anxiety
correlations_Ax_H <- subset_df7 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_H, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax_H$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and Happiness:", average_correlation)
print(message_to_print)

ggplot(subset_df7, aes(x=Response_Ax, y=Response_H)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("Happiness/Mood") +
  # Add the correlation labels
  geom_text(data=correlations_Ax_H, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```


\newpage We will now look at the relationship between feedback and anxiety (so without taking prediction or histogram into account). The correlation of -0.17 is caused by a strong negative correlation in only a few people, almost 2/3rd of people had a correlation of almost zero.

```{r echo=FALSE, warning=FALSE, message=FALSE}
# looking at the relationship between feedback, anxiety and mood
df7_fdbk <- subset(df7, Screen == "fdbk")
names(df7_fdbk)[names(df7_PE) == "Screen"] <- "Screen_fdbk"
names(df7_fdbk)[names(df7_PE) == "Response"] <- "Response_fdbk"

df7_Anxious <- subset(df7, Screen == "Anxious")
names(df7_Anxious)[names(df7_Anxious) == "Screen"] <- "Screen_Ax"
names(df7_Anxious)[names(df7_Anxious) == "Response"] <- "Response_Ax"

df7_Happy <- subset(df7, Screen == "Happy")
names(df7_Happy)[names(df7_Happy) == "Screen"] <- "Screen_H"
names(df7_Happy)[names(df7_Happy) == "Response"] <- "Response_H"

df7_fdbk_Ax_H <- df7_fdbk %>%
  inner_join(df7_Anxious,  by = c("Random_ID", "Trial.Number")) %>%
  inner_join(df7_Happy,  by = c("Random_ID", "Trial.Number"))

# merged_df7 <- inner_join(df7_SubjPE, df7_PE, by = c("Random_ID", "Trial.Number"))

# Calculate correlation by Random_ID
correlations <- df7_fdbk_Ax_H %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response, Response_Ax, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between feedback and anxiety:", average_correlation)
print(message_to_print)

ggplot(df7_fdbk_Ax_H, aes(x=Response, y=Response_Ax)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Feedback") + 
  ylab("Anxiety") +
  # Add the correlation labels
  geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
     # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```

\newpage The relationship between feedback and happiness: this relationship is stronger than the one with anxiety, and more people show a strong positive correlation.

```{r echo=FALSE, warning=FALSE, message=FALSE}
# looking at the relationship between feedback and mood
# Calculate correlation by Random_ID
correlations <- df7_fdbk_Ax_H %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response, Response_H, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between feedback and happiness:", average_correlation)
print(message_to_print)

ggplot(df7_fdbk_Ax_H, aes(x=Response, y=Response_H)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Feedback") + 
  ylab("Happiness/Mood") +
  # Add the correlation labels
  geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
     # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```


\newpage The relationship between mini-SPIN and anxiety rating:

```{r echo=FALSE, warning=FALSE, message=FALSE}
df7_spin <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_pilot_fdbk_bignrnd_typ/SUP_PRF_pilot_fdbk_bignrnd_typ_v3/SUP_PRF_pilot_fdbk_bignrnd_typ_v3_mini_spin.csv")   # Prolific,non-random feedback, text only (no video/audio) with bigger PE, once per judge

df7_spin <- df7_spin %>%
  rename(
   "Q1" =  "Rating.Scale.Fear.of.embarrassment.causes.me.to.avoid.doing.things.or.speaking.to.people.",
   "Q2" =  "Rating.Scale.I.avoid.activities.in.which.I.am.the.center.of.attention.",
   "Q3" = "Rating.Scale.Being.embarrassed.or.looking.stupid.are.among.my.worst.fears." 
  )

df7_spin <- df7_spin %>%
  rowwise() %>%
  mutate(mini_SPIN_total = sum(c(Q1, Q2, Q3), na.rm = TRUE)) %>%
  ungroup()

count <- df7_spin %>%
  summarise(count = sum(mini_SPIN_total >= 6)) %>%
  pull(count)

print(paste("Out of 36 people, these people had a mini_SPIN total score higher or equal to 6:", count))


# Exclude rows with NA in Random_ID from both data frames
df7_spin <- df7_spin[!is.na(df7_spin$Random_ID), ]
merged_df7_spinAX <- merge(df7_fdbk_Ax_H, df7_spin, by = "Random_ID")

# Calculate correlation by Random_ID
correlations_Ax_miniSPIN <- merged_df7_spinAX %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, mini_SPIN_total, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot


# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax_miniSPIN$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between mini_SPIN and anxiety:", average_correlation)
print(message_to_print)

ggplot(df7_fdbk_Ax_H, aes(x=Response, y=Response_H)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Feedback") + 
  ylab("Happiness/Mood") +
  # Add the correlation labels
  geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
     # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))


```

\newpage The next plot shows the same relationship for mood/happiness and SubjPE:
```{r echo=FALSE, warning=FALSE, message=FALSE}
# Calculate correlation by Random_ID for anxiety
correlations_H_excludedoutliers <- subset_df7 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_H_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between happiness and SubjPE:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(subset_df7$Response_H, na.rm = TRUE)
y_range <- range(subset_df7$Response_SubjPE, na.rm = TRUE)


ggplot(subset_df7, aes(x=Response_H, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Happiness/Mood") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations_H_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```
<div style="background-color: #FFFF00"> It does make sense that now that we have a bigger correlation (r ~ 0.27 compared to 0.23 before, even after adding the new subjects ~ 37 people now) since we have bigger positive PE once per judge. Shall we also create bigger negative PE, and see whether the relationship with anxiety strengthens? </div>

I will now also remove the one data point for subjects "SUPPRF56321", "SUPPRF93027", "SUPPRF10753" that may have caused the significant positive correlation, and repeat the above group correlation, to see whether it influences the results. 


\newpage The next plot shows the same relationship for mood/happiness and SubjPE after removing trials that are outliers for subjects "SUPPRF56321", "SUPPRF93027", and "SUPPRF10753":
<br>
```{r echo=FALSE, warning=FALSE, message=FALSE}
# remove outliers, we can see from the plots that the outlier values are smaller than 20
subset_df7 <- subset_df7 %>%
  group_by(Random_ID) %>%
  dplyr::filter(!(Random_ID %in% c("SUPPRF56321", "SUPPRF93027", "SUPPRF10753") & Response_H < 20))

# Calculate correlation by Random_ID for anxiety
correlations_H_excludedoutliers <- subset_df7 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_H_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between happiness and SubjPE after 1 data point for 3 people:", average_correlation)
print(message_to_print)

ggplot(subset_df7, aes(x=Response_H, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Happiness/Mood") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations_H_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```
<br>
The correlation remains around 0.27 after removing one data points for 3 subjects. I will now remove subject "SUPPRF37610" who rated always around 0 for mood to see the impact on the correlation. 
<br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
# remove outliers, we can see from the plots that the outlier values are smaller than 20
ids_to_exclude <- c("SUPPRF37610")
# Subset the data
subset_df7 <- final_df7[!final_df7$Random_ID %in% ids_to_exclude, ]


# Calculate correlation by Random_ID for anxiety
correlations_H_excludedoutliers <- subset_df7 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_H_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between happiness and SubjPE after excluding 1 outlier:", average_correlation)
print(message_to_print)

ggplot(subset_df7, aes(x=Response_H, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Happiness/Mood") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations_H_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```
<br><br>
The correlation became 0.285 from 0.27 after excluding one outlier: subject "SUPPRF37610". 
<br><br>
So the issue of having almost zero for SubjPE and having correlations around zero remains here, the only reason we have bigger group correlation is that for people who show a strong correlation, the relationship is stronger for mood compared to anxiety. <br>


\newpage We now will look whether the average correlations are significantly different from zero for both anxiety and mood. The anxiety correlation now is significantly different from zero (this was not the case before)!

```{r echo=FALSE, warning=FALSE, message=FALSE}
print("corr Anxiety and SubjPE")

t_test_result <- t.test(correlations_Ax_excludedoutliers$correlation, mu = 0) 
print(t_test_result)

print("corr happiness and SubjPE")
t_test_result <- t.test(correlations_H_excludedoutliers$correlation, mu = 0) 
print(t_test_result)

```

\newpage We now will run everything again but this time using the objective PE (feedback - histogram_mean) instead of the subjective one (feedback - prediction)

```{r echo=FALSE, warning=FALSE, message=FALSE}

ids_to_exclude <- c("SUPPRF67412")

# Subset the data
subset_df7 <- final_df7[!final_df7$Random_ID %in% ids_to_exclude, ]

# Calculate correlation by Random_ID for anxiety
correlations_Ax_excludedoutliers <- subset_df7 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_PE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and PE after excluding 1 outlier:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(subset_df7$Response_Ax, na.rm = TRUE)
y_range <- range(subset_df7$Response_PE, na.rm = TRUE)


ggplot(subset_df7, aes(x=Response_Ax, y=Response_PE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("PE: feedback - hist_m") +
  # Add the correlation labels
  geom_text(data=correlations_Ax_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```
I will remove one data point for subject "SUPPRL44350" who may have given a different answer randomly/by mistake to see how much it is influencing the data. <br><br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
# ids_to_exclude <- c("SUPPRF67412")
# 
# # Subset the data
# subset_df7 <- final_df7[!final_df7$Random_ID %in% ids_to_exclude, ]

# remove outliers, we can see from the plots that the outlier value is bigger than 50
subset_df7 <- subset_df7 %>%
  group_by(Random_ID) %>%
  dplyr::filter(!(Random_ID %in% c("SUPPRF44350") & Response_Ax > 50))

# Calculate correlation by Random_ID for anxiety
correlations_Ax_excludedoutliers <- subset_df7 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_PE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and PE after excluding 1 outlier:", average_correlation)
print(message_to_print)


ggplot(subset_df7, aes(x=Response_Ax, y=Response_PE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("PE: feedback - hist_m") +
  # Add the correlation labels
  geom_text(data=correlations_Ax_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```
<br> After removing the data point that was an outlier for subject "SUPPRL44350", the correlations between PE and axiety, and SubjPE and anxiety are similar (~ -0.169 vs -0.16) <br>

\newpage We will repeat the same thing for the relationship between PE and mood:

```{r echo=FALSE, warning=FALSE, message=FALSE}
# Calculate correlation by Random_ID for anxiety
correlations_H_excludedoutliers <- subset_df7 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_PE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_H_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between happiness and objective PE:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(subset_df7$Response_H, na.rm = TRUE)
y_range <- range(subset_df7$Response_PE, na.rm = TRUE)


ggplot(subset_df7, aes(x=Response_H, y=Response_PE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Happiness/Mood") + 
  ylab("PE: feedback - hist_m") +
  # Add the correlation labels
  geom_text(data=correlations_H_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-20, 20, by = 5), limits = c(-20, 20))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))



```
<br>
Again, the relationship between SubjPE and mood is slightly stronger than PE and mood (r = 0.285 vs 0.25), which is great news if for the attention condition, IF we did not want to ask for subjective prediction.<br>

\newpage Since these people were not screened for social anxiety, let's see how many of them had social anxiety scores higher than or equal to 6.

```{r echo=FALSE, warning=FALSE, message=FALSE}
df7_spin <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_pilot_fdbk_bignrnd_typ/SUP_PRF_pilot_fdbk_bignrnd_typ_v3/SUP_PRF_pilot_fdbk_bignrnd_typ_v3_mini_spin.csv")   # Prolific,non-random feedback, text only (no video/audio) with bigger PE, once per judge

df7_spin <- df7_spin %>%
   rename(
    "Q1" =  "Rating.Scale.Fear.of.embarrassment.causes.me.to.avoid.doing.things.or.speaking.to.people.",
   "Q2" =  "Rating.Scale.I.avoid.activities.in.which.I.am.the.center.of.attention.",
   "Q3" = "Rating.Scale.Being.embarrassed.or.looking.stupid.are.among.my.worst.fears." 
  )

df7_spin <- df7_spin %>%
  rowwise() %>%
  mutate(mini_SPIN_total = sum(c(Q1, Q2, Q3), na.rm = TRUE)) %>%
  ungroup()

count <- df7_spin %>%
  summarise(count = sum(mini_SPIN_total >= 6)) %>%
  pull(count)

print(paste("Out of 36 people, these people had a mini_SPIN total score higher or equal to 6:", count))

# Calculate correlation by Random_ID for anxiety
correlations_Ax_excludedoutliers <- subset_df7 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# Exclude rows with NA in Random_ID from both data frames
df7_spin <- df7_spin[!is.na(df7_spin$Random_ID), ]
merged_df7 <- merge(correlations_Ax_excludedoutliers, df7_spin, by = "Random_ID")

# looking at the correltion between the correlation of subjtPE and anxiety, with mini_SPIN score
group_correlation <- cor(merged_df7$correlation, merged_df7$mini_SPIN_total, use = "complete.obs")

# Print the correlation
print(group_correlation)

p <- ggplot(merged_df7, aes(x=correlation, y=mini_SPIN_total)) +
  geom_point(aes(alpha = 0.5), color = "blue") +
  geom_smooth(method = "lm", color="blue", aes()) +     
  labs(color="Legend") +
  theme_minimal() +
  xlab("correlation SubjPE and Anxiety") + 
  ylab("mini_SPIN score") +
  theme(strip.text = element_text(size = 19),
        panel.grid.major = element_blank(),  # Remove major grid lines
        panel.grid.minor = element_blank())  # Remove minor grid lines
  
p + annotate("text", x = Inf, y = Inf, 
             label = paste("Pearson r: ", round(group_correlation, 2)), 
             hjust = 1, vjust = 1, size = 5, color = "purple")

```
<br> <br>
So for people with a negative correlation between SubjPE and anxiety: the higher the PE, the lower their anxiety which makes sense.
Now, the negative correlation between the latter correlation and mini-SPIN means: the higher the mini_SPIN, the lower the latter correlation (so more negative), which also makes sense.


\newpage Let's merge the mini_SPIN with the longer format dataframe with all 8 variables, so that we can fit a regression to explore how the correlation between two variables is influenced by the mini_SPIN:



```{r echo=FALSE, warning=FALSE, message=FALSE}
# reading Eleanor's data to get the mean and SD of anxiety ratings in WITH (self-focused) and WITHOUT (externally focused) conditions

df_Eleanor <- read.csv("/Users/marjan/Desktop/aim_lab_1/Aim1.Database Stage 2_11.2019.csv")

# calculate mean and sd for the WITH condition
mean_value_WITH <- mean(df_Eleanor$Anxiety_with_Study2, na.rm = TRUE)
sd_value_WITH <- sd(df_Eleanor$Anxiety_with_Study2, na.rm = TRUE)

# calculate mean and sd for the WITHOUT condition
mean_value_WITHOUT <- mean(df_Eleanor$Anxiety_WithOUT_Study2, na.rm = TRUE)
sd_value_WITHOUT <- sd(df_Eleanor$Anxiety_WithOUT_Study2, na.rm = TRUE)

```

```{r echo=FALSE, warning=FALSE, message=FALSE}
dfall <- read.csv("/Users/marjan/Desktop/aim_lab_1/all_pilots_wide_8var.csv") 

df7_all_8_var <- subset(dfall, pilot_nr == "Pilot 7") 

# Let's first merge mini_spin total scores, with final_df10 where we have the rest of the data
df7_all_8_var <- df7_all_8_var %>%
  left_join(df7_spin %>% dplyr::select(Random_ID, mini_SPIN_total), by = "Random_ID")

df7_all_8_var$Social_Anxiety <- ifelse(df7_all_8_var$mini_SPIN_total >= 6, "high", "low")

summarized_df7 <- df7_all_8_var %>%
  group_by(Social_Anxiety, Random_ID) %>%
  summarize(
    Average_Response = mean(Anxiety, na.rm = TRUE),
    SD_Response = sd(Anxiety, na.rm = TRUE),
    .groups = "drop" # This drops the grouping structure after summarization
  )

summarized_df7$jitter <- runif(nrow(summarized_df7), min = 1, max = 10)

# summarized_df7$Pilot_Number[summarized_df7$Pilot_Number == 9] <- "Pilot 9"
# summarized_df7$Pilot_Number[summarized_df7$Pilot_Number == 10] <- "Pilot 10"

# Create a vector of IDs to exclude
ids_to_exclude <- c("SUPPRF67412", "SUPPRF37610")

# Subset the data
subset_df7_all_8_var <- df7_all_8_var[!df7_all_8_var$Random_ID %in% ids_to_exclude, ]

correlations <- subset_df7_all_8_var %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Mood, SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("r = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between feedback and happiness:", average_correlation)
print(message_to_print)

  ggplot(subset_df7_all_8_var, aes(x = Mood, y = SubjPE, color = Social_Anxiety)) +
  geom_point(aes(color= Social_Anxiety, alpha = 0.3)) +
  geom_smooth(method = "lm", color="yellow") +     
  # labs(color="Legend") +
  theme_minimal() +
  xlab("Happiness/Mood") + 
  ylab("SubjPE: feedback - prediction") +
    facet_wrap(~ Random_ID, scales = "free") +
    theme(strip.text = element_text(size = 6))+
    geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
     # Adjust the size of the facet labels
  # Add the correlation labels
    theme(
    strip.text.x = element_text(face = "bold"),  # For horizontal facet titles
    strip.text.y = element_text(face = "bold"),  # For vertical facet titles
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank()) +
    scale_color_manual(values = c("Red", "Blue"))
  
  
# let's get the average per low and high social anxiety
# concatenate the pilots, with the social anxiety scores and save as a CSV file to send to Argyris
# placing the up to date files on Github with the correct paths
# 
  
filtered_data <- subset_df7_all_8_var %>%
  dplyr::filter(pilot_nr == "Pilot 7")

correlations_per_subject <- filtered_data %>%
  group_by(Random_ID) %>%
  summarize(correlation = cor(Mood, SubjPE, use = "complete.obs"))

average_correlations <- filtered_data %>%
  left_join(correlations_per_subject, by = "Random_ID") %>%
  group_by(Social_Anxiety) %>%
  summarize(average_correlation = mean(correlation, na.rm = TRUE))

average_low <- average_correlations$average_correlation[average_correlations$Social_Anxiety == "low"]
average_high <- average_correlations$average_correlation[average_correlations$Social_Anxiety == "high"]

```

```{r echo=FALSE, warning=FALSE, message=FALSE}


modelAx <- lm(Anxiety ~ SubjPE * mini_SPIN_total, data = df7_all_8_var)
summary(modelAx)


modelH <- lm(Mood ~ SubjPE * mini_SPIN_total, data = df7_all_8_var)
summary(modelH)
```


\newpage I will now subset people with high social anxiety score and repeat the correlations
```{r echo=FALSE, warning=FALSE, message=FALSE}

subset_df7 <- subset(filtered_data, mini_SPIN_total >= 6)
ids_to_exclude <- c("SUPPRF67412")

# Subset the data
subset_df7 <- subset_df7[!subset_df7$Random_ID %in% ids_to_exclude, ]

# remove outliers, we can see from the plots that the outlier value is bigger than 50
subset_df7 <- subset_df7 %>%
  group_by(Random_ID) %>%
  dplyr::filter(!(Random_ID %in% c("SUPPRF44350") & Anxiety > 50))

# Calculate correlation by Random_ID for anxiety
correlations_Ax_excludedoutliers <- subset_df7 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Anxiety, SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and PE after excluding 1 outlier:", average_correlation)
print(message_to_print)


ggplot(subset_df7, aes(x=Anxiety, y=SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("PE: feedback - hist_m") +
  # Add the correlation labels
  geom_text(data=correlations_Ax_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```
<br> <br>
So after keeping people with high mini_SPIN scores, the correlation becomes -0.19 from -0.17. <br>




\newpage 
# ICC for anxiety pilot 7

we will now look at the ICC outcome for anxiety
<br> The ICC for anxiety is 0.76, which is moderate according to guidelines by Koo and Li (2016):<br>
<br> below 0.50: poor<br>
<br>between 0.50 and 0.75: moderate<br>
<br>between 0.75 and 0.90: good<br>
<br>above 0.90: excellent<br>
```{r echo=FALSE, warning=FALSE, message=FALSE}
library(irr)
library(lme4)
library(psych)

# change name to model null (same for all others)
model <- lme4::lmer(Response_Ax ~ 1 + (1 | Random_ID), data = final_df7)
# Extract variance components
var_components <- VarCorr(model)
subject_variance <- as.numeric(var_components[1])
residual_variance <- as.numeric(attr(var_components, "sc")^2)

# Calculate ICC
icc <- subject_variance / (subject_variance + residual_variance)
print("lmer for anxiety with just the intercept")
print(icc)

confint(model)
```


\newpage 
# ICC for mood pilot 7

The ICC for mood is 0.71, which is within the moderate category, according to guidelines by Koo and Li (2016):<br>
<br> below 0.50: poor<br>
<br>between 0.50 and 0.75: moderate<br>
<br>between 0.75 and 0.90: good<br>
<br>above 0.90: excellent<br>
```{r echo=FALSE, warning=FALSE, message=FALSE}
# change name to model null (same for all others)
model <- lme4::lmer(Response_H ~ 1 + (1 | Random_ID), data = final_df7)
# Extract variance components
var_components <- VarCorr(model)
subject_variance <- as.numeric(var_components[1])
residual_variance <- as.numeric(attr(var_components, "sc")^2)

# Calculate ICC
icc <- subject_variance / (subject_variance + residual_variance)
print("lmer for mood with just the intercept")
print(icc)

confint(model)
```

\newpage <font size="3"> ### Pilot 8: We will now look at the same data in a pilot with bigger prediction errors. Per judge we now provide a rating between 90-100 to have the maximum positive PE possible using the following experiment:https://app.gorilla.sc/admin/experiment/149662/design and task: surprise_task_PE_feedback_biggestPE (https://app.gorilla.sc/admin/task/690668/editor?version=1)

<br> <br> For this study, we did not screen for social anxiety but need to see their social anxiety scores to see how many are bigger than or equal the threshold of 6. We also have 41 subjects (there was an issue with Prolific rejecting someone whose data must have been approved, so we have now one person more than we planned).

It may also be interesting to look at the relationship between the correlation between anxiety and PE, with mini-SPIN score to see how the levels of social anxiety may influence this relationship </font>
<br> <br> 
```{r echo=FALSE, warning=FALSE, message=FALSE}
df8 <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_pilot_fdbk_biggestnrnd_typ/SUP_PRF_pilot_fdbk_biggestnrnd_typ_v3/SUP_PRF_pilot_fdbk_biggestnrnd_typ_v3_task_main.csv")
# Prolific,non-random feedback, text only (no video/audio) with bigger PE, once per judge, biggest PE (1 feedback of 90-100)

# exclude this person who has not done all the trials:
ids_to_exclude <- c("SUPPRF83676")
# Subset the data
df8 <- df8[!df8$Random_ID %in% ids_to_exclude, ]


df8_mood <- subset(df8, Response.Type == "tooEarly")
df8 <- subset(df8, Response.Type == "response")
df8 <- subset(df8, Spreadsheet..Display == "Trials ")

# defining histogram means
df8$m_hist <- ifelse(df8$Spreadsheet..Histogram == "h1.png", 20,
                       ifelse(df8$Spreadsheet..Histogram == "h2.png", 29,
                              ifelse(df8$Spreadsheet..Histogram == "h3.png", 37,
                                     ifelse(df8$Spreadsheet..Histogram == "h4.png", 46,
                                            ifelse(df8$Spreadsheet..Histogram == "h5.png", 54,
                                                   ifelse(df8$Spreadsheet..Histogram == "h6.png", 63,
                                                          ifelse(df8$Spreadsheet..Histogram == "h7.png", 71,
                                                                 ifelse(df8$Spreadsheet..Histogram == "h8.png", 80, NA)))))))) 

```

<br> 
<font size="3"> The figure below shows the relationship between histogram means and the predictions.</font>
<br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
df8_pred <- subset(df8, Screen == "Prediction ")
df8_conf <- subset(df8, Screen == "Certainty rating ")
df8_pred$Response <- as.numeric(as.character(df8_pred$Response))
df8_mood$Response <- as.numeric(as.character(df8_mood$Response))

# Calculate correlation by Random_ID for anxiety
correlations <- df8_pred %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response, m_hist, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between prediction and m_hist:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(df8_pred$Response, na.rm = TRUE)
y_range <- range(df8_pred$m_hist, na.rm = TRUE)


ggplot(df8_pred, aes(x=Response, y=m_hist)) +
  geom_point(aes(color="Data Points"),size = 0.5) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Expectation") + 
  ylab("Histogram means") +
  xlim(c(0, 100)) +  # Set your desired x limits
  ylim(c(0, 100)) +  # Set your desired y limits
  # Add the correlation labels
  geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold",    
             inherit.aes=FALSE) +
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(20, 100, by = 20), limits = c(20, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))
```

<br><br><br>
<font size="3"> The group correlation is less than before (0.56 vs around 0.68?). Some people (subjects "SUPPRF30226", "SUPPRF44058", "SUPPRF74630", "SUPPRF83713") have ignored the histogram values, either it is due to bigger PE which we should be able to see below, across trials, or it was just random. Below we can see the histogram means and expectation values across trials:</font>
<br><br><br>


```{r echo=FALSE, warning=FALSE, message=FALSE}
df8_pred_trial_nr <- df8_pred %>%
  group_by(Random_ID) %>%
  mutate(trial_nr = row_number()) %>%
  ungroup()

df8_long <- df8_pred_trial_nr %>%
  pivot_longer(cols = c(Response, m_hist), names_to = "Metric", values_to = "Value") %>%
  mutate(Metric = recode(Metric, 
                         Response = "Predictions", 
                         m_hist = "Histograms"))

# Create the plot with facet_wrap
ggplot(df8_long, aes(x = Trial.Number, y = Value, color = Metric, group = Metric)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Expectation across time",
       x = "Trial Number",
       y = "Expectation",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) + # Separate plot for each ID, one column layout
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 50, by = 10), limits = c(0, 50)) +
  scale_y_continuous(breaks = seq(20, 100, by = 20), limits = c(20, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))
```
<br><br><br>
<br> 
<font size="3"> So we have less overlap between histogram and predictions which makes sense, it would be interesting to see its impact on mood and anxiety. We will first make the same plots for mood (asking people how happy they are) and anxiety before looking at their correlations. </font>
<br>

```{r echo=FALSE, warning=FALSE, message=FALSE}

# Create the plot with facet_wrap
ggplot(df8_mood, aes(x = Trial.Number, y = Response, color = Display, group = Display)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Mood and anxiety across time",
       x = "Trial Number",
       y = "mood/happiness and anxiety",
       color = "") +
  facet_wrap(~ Random_ID, ncol = 6) + # Separate plot for each ID, one column layout
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 50, by = 10), limits = c(0, 50)) +
  scale_y_continuous(breaks = seq(0, 100, by = 20), limits = c(0, 100))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```



```{r echo=FALSE, warning=FALSE, message=FALSE}
df8_pred$Response <- as.numeric(as.character(df8_pred$Response))

correlations_mean <- df8_pred %>%
  group_by(Random_ID) %>%
  summarize(correlation = cor(Response, m_hist, use = "complete.obs"),
            .groups = 'drop')  # This line is used to avoid a grouped df8 as output

```

<br><br><br>
<font size="3"> Below we can see the average correlation and the histogram of the individual correlations. </font>
<br><br><br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
m <- mean(correlations_mean$correlation)
print(paste("average of correlations:", m))
s <- sd(correlations_mean$correlation)
print(paste("sd of correlations:", s))

hist(correlations_mean$correlation)
```

Now let's make plots for each subject that show how prediction, feedback, histogram mean, anxiety, mood, confidence rating, PE (feedback - histogram), subj_PE (feedback-prediction).


```{r echo=FALSE, warning=FALSE, message=FALSE}

df8_raw <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_pilot_fdbk_biggestnrnd_typ/SUP_PRF_pilot_fdbk_biggestnrnd_typ_v3/SUP_PRF_pilot_fdbk_biggestnrnd_typ_v3_task_main.csv")   # Prolific,non-random feedback, text only (no video/audio) with biggest PE (1 feedback between 90-100), once per judge, 41 subjects

# create a new df8 that only keeps the columns we need
df8 <- df8_raw[, c("Trial.Number", "Display", "Screen", "Response.Type", "Response", 
                      "Reaction.Time", "Spreadsheet..Histogram", "Spreadsheet..Feedback", "Random_ID")]
# exclude this person who has not done all the trials:
ids_to_exclude <- c("SUPPRF83676")
# Subset the data
df8 <- df8[!df8$Random_ID %in% ids_to_exclude, ]

df8 <- df8 %>%
  mutate(Response = as.numeric(as.character(Response))) %>%
  filter(!is.na(Response))

# add the histogram values depending on file name:
df8$m_hist <- ifelse(df8$Spreadsheet..Histogram == "h1.png", 20,
                       ifelse(df8$Spreadsheet..Histogram == "h2.png", 29,
                              ifelse(df8$Spreadsheet..Histogram == "h3.png", 37,
                                     ifelse(df8$Spreadsheet..Histogram == "h4.png", 46,
                                            ifelse(df8$Spreadsheet..Histogram == "h5.png", 54,
                                                   ifelse(df8$Spreadsheet..Histogram == "h6.png", 63,
                                                          ifelse(df8$Spreadsheet..Histogram == "h7.png", 71,
                                                                 ifelse(df8$Spreadsheet..Histogram == "h8.png", 80, NA))))))))  


# get rid of the rows we don't need: practice runs, continue button presses etc. and only keep Trials, Anxiety and Mood that include all variables we are interested in:
df8 <- df8 %>%
  filter(
    (Display == "Trials ") |
    (Display == "Anxiety " & !Trial.Number %in% c(1, 2)) |
    (Display == "Mood " & !Trial.Number %in% c(1, 2)) 
  )

# setting Mood and Anxiety trial numbers to match the trials starting from 1 (since we removed the baseline ones above)
df8$Trial.Number <- ifelse(df8$Display == 'Mood ' | df8$Display == 'Anxiety ', df8$Trial.Number - 2, df8$Trial.Number)
df8$Display <- ifelse(df8$Display == 'Mood ' | df8$Display == 'Anxiety ', "Trials", df8$Display)

# renaming the feedback column to fdbk
names(df8)[names(df8) == 'Spreadsheet..Feedback'] <- 'fdbk'

# Now let's create columns for PE (fdbk-hist) and Subj_PE (fdbk_Prediction)

df8$SubjPE <- ifelse(df8$Screen == "Prediction ", df8$fdbk - df8$Response, NA)
df8$PE <- ifelse(df8$Screen == "Prediction ", df8$fdbk - df8$m_hist, NA)
# to keep just one repetition of feedback and mean histogram per trial per subject 
# and replace the rest with NA so that when we want to convert to long format we won't have duplicates
df8$fdbk <- ifelse(df8$Screen == "Prediction ", df8$fdbk, NA)
df8$m_hist <- ifelse(df8$Screen == "Prediction ", df8$m_hist, NA)


long_df8 <- df8 %>%
  select(Random_ID, Trial.Number, fdbk, m_hist, PE, SubjPE) %>%
  pivot_longer(cols = c(fdbk, m_hist, PE, SubjPE),
               names_to = "Screen",
               values_to = "Response")


# This will keep only the rows where 'Response' is not NA
long_df8 <- long_df8[!is.na(long_df8$Response), ]

  
# Selecting relevant columns from the original df8
df8 <- df8 %>%
  select(-c(fdbk, m_hist, PE, SubjPE))

# Binding the rows together
df8 <- bind_rows(df8, long_df8)

```

<br><br> It seems below we have bigger variability in subjective ratings of mood and anxiety compared to our initial pilots which may be a conincidence/noise or related to the bigger PE. <br><br>

```{r echo=FALSE, warning=FALSE, message=FALSE}

random_ids <- unique(df8$Random_ID)

list_of_df8s <- list()

for (i in seq_along(random_ids)) {
  x <- random_ids[i]  # Get the current value from random_ids
  df8_si <- subset(df8, Random_ID == x)  # Create the subset
  list_of_df8s[[paste0("df8_s", i)]] <- df8_si  # Add the subset to list_of_df8s
}

plot_function <- function(df8, title) {
  p <- ggplot(df8, aes(x = Trial.Number, y = Response, color = Screen, group = Screen)) +
    geom_line() +
    theme_minimal() +
    labs(title = title,  # Set the title to the Random_ID
         x = "Trial Number",
         y = "Mood Ratings/Expectations/ PE",
         color = "") +
    facet_wrap(~ Screen, ncol = 2) +
    geom_hline(yintercept = 0)
  
  return(p)
}

# Use Map or mapply to apply the plot_function to each data frame and title in the list
list_of_plots <- Map(plot_function, list_of_df8s, random_ids)


for (i in seq_along(list_of_plots)) {
  print(list_of_plots[[i]])
}

```


```{r echo=FALSE, warning=FALSE, message=FALSE}
# if you need to correlate variables using the long dataset, it is very simple
df8$Response <- as.numeric(df8$Response)

cors_by_id <- numeric(length(random_ids))

# Loop through each ID
for (i in seq_along(random_ids)) {
  # Subset data for current ID
  current_id <- random_ids[i]
  d_PE <- df8[df8$Screen == "PE" & df8$Random_ID == current_id, ]$Response
  d_SubjPE <- df8[df8$Screen == "SubjPE" & df8$Random_ID == current_id, ]$Response
  
  # Calculate correlation for the current ID
  cors_by_id[i] <- cor(d_PE, d_SubjPE, use = "complete.obs")  # 'complete.obs' to ignore NA values
}

# Print the correlations
# print(cors_by_id)
```


\newpage We now look at the relationship between PE (feedback - histogram_mean) and SubjPE (feedback - prediction):

```{r echo=FALSE, warning=FALSE, message=FALSE}
# looking at the relationship between PE and SubjPE
df8_PE <- subset(df8, Screen == "PE")
names(df8_PE)[names(df8_PE) == "Screen"] <- "Screen_PE"
names(df8_PE)[names(df8_PE) == "Response"] <- "Response_PE"


df8_SubjPE <- subset(df8, Screen == "SubjPE")
names(df8_SubjPE)[names(df8_SubjPE) == "Screen"] <- "Screen_SubjPE"
names(df8_SubjPE)[names(df8_SubjPE) == "Response"] <- "Response_SubjPE"

merged_df8 <- inner_join(df8_SubjPE, df8_PE, by = c("Random_ID", "Trial.Number"))


# Calculate correlation by Random_ID
correlations <- merged_df8 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_PE, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between PE and SubjPE:", average_correlation)
print(message_to_print)

ggplot(merged_df8, aes(x=Response_PE, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("PE: feedback - hist_mean") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
     # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(-20, 20, by = 5), limits = c(-20, 20)) +
  scale_y_continuous(breaks = seq(-50, 50, by = 10), limits = c(-50, 50))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))
```
<br><br> Correlation between SubjPE and objective PE remain similar, slightly less (I think from 0.68 it is 0.64 now).


\newpage Let's now look at the relationship between SubjPE and Anxiety:

```{r echo=FALSE, warning=FALSE, message=FALSE}
# looking at the relationship between PE, SubjPE, anxiety and mood:
df8_Anxious <- subset(df8, Screen == "Anxious")
names(df8_Anxious)[names(df8_Anxious) == "Screen"] <- "Screen_Ax"
names(df8_Anxious)[names(df8_Anxious) == "Response"] <- "Response_Ax"

df8_Happy <- subset(df8, Screen == "Happy")
# df8_fdbk <- subset(df8, Screen == "Prediction")
names(df8_Happy)[names(df8_Happy) == "Screen"] <- "Screen_H"
names(df8_Happy)[names(df8_Happy) == "Response"] <- "Response_H"

final_df8 <- merged_df8 %>%
  inner_join(df8_Anxious, by = c("Random_ID", "Trial.Number")) %>%
  inner_join(df8_Happy, by = c("Random_ID", "Trial.Number"))

# Calculate correlation by Random_ID for anxiety
correlations_Ax_excludedoutliers <- final_df8 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and SubjPE:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(final_df8$Response_Ax, na.rm = TRUE)
y_range <- range(final_df8$Response_SubjPE, na.rm = TRUE)

ggplot(final_df8, aes(x=Response_Ax, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
     # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```
I have not removed anyone to repeat this correlation because we have many people who have rated the same throughout the task ("SUPPRF00818", "SUPPRF12765", "SUPPRF21828", "SUPPRF25745", "SUPPRF77733", ""SUPPRF79962", "SUPPRF97320"), and some people who have just one point that is an outlier ("SUPPRF30226","SUPPRF03421", "SUPPRF12765", "SUPPRF32902").


\newpage Let's have a look at histograms of SubjPE, PE, feedback and histogram means:
```{r echo=FALSE, , warning=FALSE, message=FALSE, out.extra='width=\\textwidth, height=\\textheight, keepaspectratio'}
ggplot(long_df8, aes(x = Response)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black", alpha = 0.5) +
  geom_rug(sides = "b", color = "red", size = 0.5) +
  facet_wrap(~ Screen) +
  labs(title = "Histogram of Responses", x = "Response Value", y = "Frequency") +
  theme_minimal()
```


\newpage We will now look at histograms of anxiety and mood:

```{r echo=FALSE, , warning=FALSE, message=FALSE, out.extra='width=\\textwidth, height=\\textheight, keepaspectratio'}
ggplot(final_df8, aes(x = Response_Ax)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black", alpha = 0.5) +
  geom_rug(sides = "b", color = "red", size = 0.5) +
  # facet_wrap(~ Screen) +
  labs(title = "Histogram of Responses", x = "Anxiety Ratings", y = "Frequency") +
  theme_minimal()
```

```{r echo=FALSE, , warning=FALSE, message=FALSE, out.extra='width=\\textwidth, height=\\textheight, keepaspectratio'}
ggplot(final_df8, aes(x = Response_H)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black", alpha = 0.5) +
  geom_rug(sides = "b", color = "red", size = 0.5) +
  # facet_wrap(~ Screen) +
  labs(title = "Histogram of Responses", x = "Mood/Happiness Ratings", y = "Frequency") +
  theme_minimal()
```


\newpage 
# ICC for anxiety pilot 7

we will now look at the ICC outcome for anxiety
<br> The ICC for anxiety is 0.76, which is moderate according to guidelines by Koo and Li (2016):<br>
<br> below 0.50: poor<br>
<br>between 0.50 and 0.75: moderate<br>
<br>between 0.75 and 0.90: good<br>
<br>above 0.90: excellent<br>
```{r echo=FALSE, warning=FALSE, message=FALSE}
library(irr)
library(lme4)
library(psych)

# change name to model null (same for all others)
model <- lme4::lmer(Response_Ax ~ 1 + (1 | Random_ID), data = final_df7)
# Extract variance components
var_components <- VarCorr(model)
subject_variance <- as.numeric(var_components[1])
residual_variance <- as.numeric(attr(var_components, "sc")^2)

# Calculate ICC
icc <- subject_variance / (subject_variance + residual_variance)
print("lmer for anxiety with just the intercept")
print(icc)

confint(model)
```


\newpage 
# ICC for anxiety pilot 8

The ICC for anxiety is 0.80, which is within the good category, according to guidelines by Koo and Li (2016):<br>
<br> below 0.50: poor<br>
<br>between 0.50 and 0.75: moderate<br>
<br>between 0.75 and 0.90: good<br>
<br>above 0.90: excellent<br>

```{r echo=FALSE, warning=FALSE, message=FALSE}
model <- lmer(Response_Ax ~ 1 + (1 | Random_ID), data = final_df8)
# Extract variance components
var_components <- VarCorr(model)
subject_variance <- as.numeric(var_components[1])
residual_variance <- as.numeric(attr(var_components, "sc")^2)

# Calculate ICC
icc <- subject_variance / (subject_variance + residual_variance)
print("lmer for anxiety with just the intercept")
print(icc)

confint(model)
```
<br> Here’s a brief interpretation of each component for anxiety ratings:
<br>**.sig01 (Between-Subjects Variance)**: The variance between subjects (likely corresponding to Random_ID in our model) is estimated to be between 18.94522 and 29.34671 with 95% confidence. This means that there is a 95% chance that the true between-subject variance falls within this range.<br>
<br>**.sigma (Within-Subject Variance or Residual Variance):** The variance within subjects is estimated to be between 11.41832 and 12.16992 with 95% confidence. This variance captures the variation in responses that is not explained by the between-subject differences.<br>
<br>**(Intercept):** The overall mean (Intercept) of the anxiety rating across all subjects is estimated to be between 17.97854 and 32.57256 with 95% confidence. This is the average response you'd expect when all other variables in the model are held at their reference levels.
<br> The ICC value of **0.80** indicates that approximately 80% of the variability in the data can be attributed to differences between subjects. The higher the ICC, the more the total variability is due to between-subject differences rather than within-subject or residual error. An ICC of 0.80 is generally considered a high value, indicating good reliability between subjects according to guidelines given by Koo and Li (2016).<br>


\newpage 
# ICC for mood pilot 8
```{r echo=FALSE, warning=FALSE, message=FALSE}
model <- lmer(Response_H ~ 1 + (1 | Random_ID), data = final_df8)

# Extract variance components
var_components <- VarCorr(model)
subject_variance <- as.numeric(var_components[1])
residual_variance <- as.numeric(attr(var_components, "sc")^2)

# Calculate ICC
icc <- subject_variance / (subject_variance + residual_variance)
print("lmer for mood with just the intercept")
print(icc)

confint(model)
```
<br> Here’s a brief interpretation of each component for mood ratings:
<br>**.sig01 (Between-Subjects Variance)**: The variance between subjects (likely corresponding to Random_ID in our model) is estimated to be between 14.88829 and 23.15984 with 95% confidence. This means that there is a 95% chance that the true between-subject variance falls within this range.<br>
<br>**.sigma (Within-Subject Variance or Residual Variance):** The variance within subjects is estimated to be between 14.90991 and 15.89133 with 95% confidence. This variance captures the variation in responses that is not explained by the between-subject differences.<br>
<br>**(Intercept):** The overall mean (Intercept) of the mood rating across all subjects is estimated to be between 53.87638 and 65.42972 with 95% confidence. This is the average response you'd expect when all other variables in the model are held at their reference levels.
<br> The ICC value of **0.59** indicates that approximately 59% of the variability in the data can be attributed to differences between subjects. The higher the ICC, the more the total variability is due to between-subject differences rather than within-subject or residual error. An ICC of 0.59 is generally considered a **moderate** value, indicating moderate reliability between subjects, according to guidelines given by Koo and Li (2016).<br>

\newpage Correlation between first and last trial (actually trial 47 instead of 48 since one subject missed the final trial due to what was presented in the next screen, we have fixed this issue now) for both mood and anxiety:
```{r echo=FALSE, warning=FALSE, message=FALSE}
print("Correlation between first and penultimate anxiety rating")
# cor.test(final_df8[final_df8$Trial.Number==1, ]$Response_H, final_df8[final_df83$Trial.Number==48, ]$Response_H)

# 
# # Create a list of unique Random_IDs that occur in either Trial.Number == 1 or Trial.Number == 48
# unique_ids <- unique(c(final_df8$Random_ID[final_df8$Trial.Number == 1], final_df8$Random_ID[final_df8$Trial.Number == 48]))
# # 
# # # Initialize a data frame to store the count of occurrences for each Random_ID in both trials
# count_df8 <- data.frame(Random_ID = unique_ids, Count_Trial_1 = NA, Count_Trial_48 = NA)
# # 
# # # Loop through each Random_ID and count occurrences in each trial
# for (id in unique_ids) {
#   count_df8$Count_Trial_1[count_df8$Random_ID == id] <- sum(final_df8$Random_ID == id & final_df8$Trial.Number == 1)
#   count_df8$Count_Trial_48[count_df8$Random_ID == id] <- sum(final_df8$Random_ID == id & final_df8$Trial.Number == 48)
# }
# # 
# # # Identify Random_IDs where the count is different between the two trials
# different_counts <- count_df8[count_df8$Count_Trial_1 != count_df8$Count_Trial_48, ]
# print(different_counts)

# this person misses the very last trial: SUPPRF87060, so we will instead of the final trial look at the 47th trial:

cor.test(final_df8[final_df8$Trial.Number==1, ]$Response_Ax, final_df8[final_df8$Trial.Number==47, ]$Response_Ax)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
print("Correlation between first and 47th/penultimate mood rating")
cor.test(final_df8[final_df8$Trial.Number==1, ]$Response_H, final_df8[final_df8$Trial.Number==47, ]$Response_H)
```


\newpage The next plot shows the same relationship for mood/happiness and SubjPE:
```{r echo=FALSE, warning=FALSE, message=FALSE}
# Calculate correlation by Random_ID for anxiety
correlations_H_excludedoutliers <- final_df8 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_H_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between happiness and SubjPE:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(final_df8$Response_H, na.rm = TRUE)
y_range <- range(final_df8$Response_SubjPE, na.rm = TRUE)


ggplot(final_df8, aes(x=Response_H, y=Response_SubjPE)) +
  geom_point(aes(color="Data Points", alpha = 0.3)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Happiness/Mood") + 
  ylab("SubjPE: feedback - prediction") +
  # Add the correlation labels
  geom_text(data=correlations_H_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))
```
<div style="background-color: #FFFF00"> So there are a few people that have again rated the same number. The correlation is now 0.15 from 0.285 in the previous pilot. </div>


\newpage We now will look whether the average correlations are significantly different from zero for both anxiety and mood. The anxiety correlation now is significantly different from zero (this was not the case before)!

```{r echo=FALSE, warning=FALSE, message=FALSE}
print("corr Anxiety and SubjPE")

t_test_result <- t.test(correlations_Ax_excludedoutliers$correlation, mu = 0) 
print(t_test_result)

print("corr happiness and SubjPE")
t_test_result <- t.test(correlations_H_excludedoutliers$correlation, mu = 0) 
print(t_test_result)

```

\newpage We now will run everything again but this time using the objective PE (feedback - histogram_mean) instead of the subjective one (feedback - prediction)

```{r echo=FALSE, warning=FALSE, message=FALSE}

subset_df8 <- final_df8

# Calculate correlation by Random_ID for anxiety
correlations_Ax_excludedoutliers <- subset_df8 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_PE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and PE after excluding 1 outlier:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(subset_df8$Response_Ax, na.rm = TRUE)
y_range <- range(subset_df8$Response_PE, na.rm = TRUE)


ggplot(subset_df8, aes(x=Response_Ax, y=Response_PE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("PE: feedback - hist_m") +
  # Add the correlation labels
  geom_text(data=correlations_Ax_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```
Again similar to SubjPE, close to zero! <br><br>


\newpage We will repeat the same thing for the relationship between PE and mood:

```{r echo=FALSE, warning=FALSE, message=FALSE}
# Calculate correlation by Random_ID for anxiety
correlations_H_excludedoutliers <- subset_df8 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_H, Response_PE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_H_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between happiness and objective PE:", average_correlation)
print(message_to_print)

# Determine the range for the data if we want all plots to have the same limits, to know what limits to choose
x_range <- range(subset_df8$Response_H, na.rm = TRUE)
y_range <- range(subset_df8$Response_PE, na.rm = TRUE)


ggplot(subset_df8, aes(x=Response_H, y=Response_PE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Happiness/Mood") + 
  ylab("PE: feedback - hist_m") +
  # Add the correlation labels
  geom_text(data=correlations_H_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-20, 20, by = 5), limits = c(-20, 20))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))


```
<br>
Again, the relationship between SubjPE and mood is similar to SubjPE and much lower than the previous pilot (which may be a coincidence, we have had a few less reliable participants, or it has been due to the bigger PE).<br>

\newpage Since these people were not screened for social anxiety, let's see how many of them had social anxiety scores higher than or equal to 6.

```{r echo=FALSE, warning=FALSE, message=FALSE}
df8_spin <- read.csv("/Users/marjan/Desktop/aim_lab_1/SUP_PRF_pilot_fdbk_biggestnrnd_typ/SUP_PRF_pilot_fdbk_biggestnrnd_typ_v3/SUP_PRF_pilot_fdbk_biggestnrnd_typ_v3_mini_spin.csv")   # Prolific,non-random feedback, text only (no video/audio) with biggest PE, once per judge

df8_spin <- df8_spin %>%
  rename(
   "Q1" =  "Rating.Scale.object.2.Fear.of.embarrassment.causes.me.to.avoid.doing.things.or.speaking.to.people.",
   "Q2" =  "Rating.Scale.object.2.I.avoid.activities.in.which.I.am.the.center.of.attention.",
   "Q3" = "Rating.Scale.object.2.Being.embarrassed.or.looking.stupid.are.among.my.worst.fears." 
  )

df8_spin <- df8_spin %>%
  rowwise() %>%
  mutate(mini_SPIN_total = sum(c(Q1, Q2, Q3), na.rm = TRUE)) %>%
  ungroup()

count <- df8_spin %>%
  summarise(count = sum(mini_SPIN_total >= 6)) %>%
  pull(count)

print(paste("Out of 41 people, these people had a mini_SPIN total score higher or equal to 6:", count))

# Calculate correlation by Random_ID for anxiety
correlations_Ax_excludedoutliers <- subset_df8 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_SubjPE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# Exclude rows with NA in Random_ID from both data frames
df8_spin <- df8_spin[!is.na(df8_spin$Random_ID), ]
merged_df8 <- merge(correlations_Ax_excludedoutliers, df8_spin, by = "Random_ID")

# looking at the correltion between the correlation of subjtPE and anxiety, with mini_SPIN score
group_correlation <- cor(merged_df8$correlation, merged_df8$mini_SPIN_total, use = "complete.obs")

# Print the correlation
print(group_correlation)

p <- ggplot(merged_df8, aes(x=correlation, y=mini_SPIN_total)) +
  geom_point(aes(alpha = 0.5), color = "blue") +
  geom_smooth(method = "lm", color="blue", aes()) +     
  labs(color="Legend") +
  theme_minimal() +
  xlab("correlation SubjPE and Anxiety") + 
  ylab("mini_SPIN score") +
  theme(strip.text = element_text(size = 19),
        panel.grid.major = element_blank(),  # Remove major grid lines
        panel.grid.minor = element_blank())  # Remove minor grid lines
  
p + annotate("text", x = Inf, y = Inf, 
             label = paste("Pearson r: ", round(group_correlation, 2)), 
             hjust = 1, vjust = 1, size = 5, color = "purple")

```
<br> <br>
Less than 50% of people had high social anxiety in this cohort, but we can also see whether there was an interaction with social anxiety below.

\newpage Let's merge the mini_SPIN with the longer format dataframe with all 8 variables, so that we can fit a regression to explore how the correlation between two variables is influenced by the mini_SPIN:

```{r echo=FALSE, warning=FALSE, message=FALSE}

df8_long_mini_SPIN <- subset_df8 %>%
  left_join(df8_spin, by = "Random_ID")

model <- lm(Response_Ax ~ Response_SubjPE * mini_SPIN_total, data = df8_long_mini_SPIN)
summary(model)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}

model <- lm(Response_H ~ Response_SubjPE * mini_SPIN_total, data = df8_long_mini_SPIN)
summary(model)
```


\newpage I will now subset people with high social anxiety score and repeat the correlations
```{r echo=FALSE, warning=FALSE, message=FALSE}

subset_df8 <- subset(df8_long_mini_SPIN, mini_SPIN_total >= 6)

# remove outliers, we can see from the plots that the outlier value is bigger than 50
subset_df8 <- subset_df8 %>%
  group_by(Random_ID) %>%
  dplyr::filter(!(Random_ID %in% c("SUPPRF44350") & Response_Ax > 50))

# Calculate correlation by Random_ID for anxiety
correlations_Ax_excludedoutliers <- subset_df8 %>%
  group_by(Random_ID) %>%
  summarise(correlation = cor(Response_Ax, Response_PE, use = "complete.obs")) %>%
  mutate(label = paste("R = ", round(correlation, digits = 2)))  # create a label for the plot

# calculate the average correlation across all individuals and print it 
average_correlation <- mean(correlations_Ax_excludedoutliers$correlation, na.rm = TRUE)
message_to_print <- paste("average correlation between Anxiety and PE after excluding 1 outlier:", average_correlation)
print(message_to_print)


ggplot(subset_df8, aes(x=Response_Ax, y=Response_PE)) +
  geom_point(aes(color="Data Points", alpha = 0.5)) +
  geom_smooth(method = "lm", color="blue", aes(group=Random_ID)) +     
  labs(color="Legend") +
  facet_wrap(~ Random_ID, scales = "free") +
  theme_minimal() +
  xlab("Anxiety") + 
  ylab("PE: feedback - hist_m") +
  # Add the correlation labels
  geom_text(data=correlations_Ax_excludedoutliers, aes(x=Inf, y=Inf, label=label, group=Random_ID), hjust=1.1, vjust=1.1, size=2.7, fontface = "bold", inherit.aes=FALSE) +
    # Adjust the size of the facet labels
  theme(strip.text = element_text(size = 6)) +  # you can change the size value as needed
  scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
  scale_y_continuous(breaks = seq(-80, 80, by = 20), limits = c(-80, 80))+
  theme(axis.text.x = element_text(size = 5),axis.text.y = element_text(size = 5))

```
<br><br> OK this did not change much either, so not related to social anxiety scores but to bad luck with the participants or this way of introducing feedback is not ideal? They may discard not only histogram values but also perform less reliably if they don't think the other person is being reliable? Especially if they performed poorly and got a score of 100%? Maybe a bigger negative PE would have the reverse impact on anxiety and mood? Can we try it? <br><br>


